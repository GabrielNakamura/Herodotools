<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using Biogeographical Stochastic Mapping on Herodotools • Herodotools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using Biogeographical Stochastic Mapping on Herodotools">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Herodotools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/bsm_analysis.html">Using Biogeographical Stochastic Mapping on Herodotools</a></li>
    <li><a class="dropdown-item" href="../articles/building-evoregions.html">Computing evoregions analysis</a></li>
    <li><a class="dropdown-item" href="../articles/community-phylogenetic-metrics.html">community-phylogenetic-metrics</a></li>
    <li><a class="dropdown-item" href="../articles/Intro_calc_insitu_dispersal.html">Calculating in situ diversification and historical dispersal</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using Biogeographical Stochastic Mapping on Herodotools</h1>
            
      

      <div class="d-none name"><code>bsm_analysis.Rmd</code></div>
    </div>

    
    
<p>To evaluate the imprints of historical processes on assemblages
<a href="https://gabrielnakamura.github.io/Herodotools/">Herodotools</a> has based its assessments of historical
events on the ancestral area reconstruction. Here, we use the
Biogeographical Stochastic Mapping to account for uncertainty in the
ancestral area reconstruction as well as to provide a more precise
measurements of the timing of the events.</p>
<p>The Biogeographical Stochastic Mapping (BSM) is a method implemented
in the <a href="http://phylo.wikidot.com/biogeobears" class="external-link">BioGeoBEARS</a> package <a href="https://doi.org/10.1111/jbi.12898" class="external-link">(Dupin et al. 2017)</a>, which
uses the parameters of a biogeographical model (e.g. DEC model) to map
on the phylogenetic tree the ancestral area on cladogenetic and
anagenetic events. The function <code>runBSM</code> in the
<a href="http://phylo.wikidot.com/biogeobears" class="external-link">BioGeoBEARS</a> package uses a probabilistic model of
dispersal and vicariance to map the evolution of ancestral range along
the branches of the tree. Each map simulates the range evolution on the
phylogenetic tree by randomly assigning range area according to the
model’s parameters and the phylogeny. It allows you to observe the
variability and uncertainty of biogeographic history across multiple
runs.</p>
<p>We have included BSM into the <a href="https://gabrielnakamura.github.io/Herodotools/">Herodotools</a> workflow and
this article shows you how to use the new functionality.</p>
<div class="section level3">
<h3 id="akodon-data">Akodon data<a class="anchor" aria-label="anchor" href="#akodon-data"></a>
</h3>
<p>We will use data from the genus <em>Akodon</em> to exemplify the
workflow. In the article <strong>Using Herodotools to analyses of
historical biogeography</strong>, we have defined the evolutionary
regions, and estimated the biogeographical ancestral area. Here we will
use those data to go further and run the BSM. After having the BSM
results, we will walk you thought the steps to get calculate the
assemblage metrics of in situ diversification, age of arrival,
Phylogenetic Endemism and Phylogenetic Diversity, as well as the
historical dispersal events from the assemblage level perspective.</p>
</div>
<div class="section level3">
<h3 id="run-biogeographical-stochastic-mapping">Run Biogeographical Stochastic Mapping<a class="anchor" aria-label="anchor" href="#run-biogeographical-stochastic-mapping"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># load the package -------------------------------------------------------------</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gabrielnakamura.github.io/Herodotools/">Herodotools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Nowosad/rcartocolor" class="external-link">rcartocolor</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># load the data ----------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># phylogeny</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"akodon_newick"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assemblages</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"akodon_sites"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Biogeographical Model (DEC)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"resDEC"</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Paths to tree and geography files</span></span>
<span><span class="va">tree_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"akodon.new"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span></span>
<span><span class="va">phyllip_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"geo_area_akodon.data"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span></span></code></pre></div>
<p>To calculate the Stochastic Mapping you need to have the
Biogeographical Model, from which the model parameters will be
extracted. You need to inform also, the path to the phylogenetic tree
and the phyllip file used in the biogeographical model. Then, the number
of stochastic mappings you want to simulate. In this example we are
using a small set, only 10 maps. The <code><a href="../reference/calc_bsm.html">calc_bsm()</a></code>is wrapping
function of the<code>runBSM()</code> from <a href="http://phylo.wikidot.com/biogeobears" class="external-link">BioGeoBEARS</a>.
The output of the function is a list containing the simulated mappings.
There are two elements, one with the cladogentic and the other with the
anagenetic events.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calc_bsm ---------------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">bsm_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_bsm.html">calc_bsm</a></span><span class="op">(</span></span>
<span>   BioGeoBEARS.data <span class="op">=</span> <span class="va">resDEC</span>,</span>
<span>   phyllip.file <span class="op">=</span> <span class="va">phyllip_path</span>,</span>
<span>   tree.path <span class="op">=</span> <span class="va">tree_path</span>,</span>
<span>   max.maps <span class="op">=</span> <span class="fl">50</span>,</span>
<span>   n.maps.goal <span class="op">=</span> <span class="fl">10</span>,</span>
<span>   seed <span class="op">=</span> <span class="fl">1234</span></span>
<span> <span class="op">)</span></span>
<span> </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prepare-phylogeny-for-herodotoolss-functions">Prepare phylogeny for <code>{Herodotools}</code>’s functions<a class="anchor" aria-label="anchor" href="#prepare-phylogeny-for-herodotoolss-functions"></a>
</h3>
<p>The functions in <a href="https://gabrielnakamura.github.io/Herodotools/">Herodotools</a> were designed to map the
node in the phylogeny and track changes range form the tip to the root
of the phylogeny. To be able to track the changes using the BSM we add
new nodes to the phylogeny. The new nodes are non-bifurcating nodes that
represents a change in the range area state. If the change is due to
anagenesis, we use the event time to place it in the daughter branch. If
it has a cladogenesis source, we add it on the daughter branch, but very
close to the parent node (1e-20).</p>
<p>We have two steps for these additions, first we need to create a data
frame for the node insertions and the node area (before insertions). We
do it using the functions <code><a href="../reference/get_insert_df.html">get_insert_df()</a></code> and
<code><a href="../reference/get_bsm_node_area.html">get_bsm_node_area()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># prepare the insertions -------------------------------------------------------</span></span>
<span><span class="co">## get_insert_df ----</span></span>
<span></span>
<span><span class="va">insert_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_insert_df.html">get_insert_df</a></span><span class="op">(</span></span>
<span>   <span class="va">bsm_result</span>,</span>
<span>   phyllip.file <span class="op">=</span> <span class="va">phyllip_path</span>,</span>
<span>   max.range.size <span class="op">=</span> <span class="va">resDEC</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">max_range_size</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span><span class="co">## get_bsm_node_area ----</span></span>
<span></span>
<span><span class="va">node_area_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_bsm_node_area.html">get_bsm_node_area</a></span><span class="op">(</span></span>
<span>  bsm <span class="op">=</span> <span class="va">bsm_result</span>, </span>
<span>  BioGeoBEARS.data <span class="op">=</span> <span class="va">resDEC</span>,</span>
<span>  phyllip.file <span class="op">=</span> <span class="va">phyllip_path</span>,</span>
<span>  tree.path <span class="op">=</span> <span class="va">tree_path</span>,</span>
<span>  max.range.size <span class="op">=</span> <span class="va">resDEC</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">max_range_size</span><span class="op">)</span></span></code></pre></div>
<p>Then we used it in the <code><a href="../reference/insert_nodes.html">insert_nodes()</a></code> to insert the
nodes to the phylogeny. The <code><a href="../reference/insert_nodes.html">insert_nodes()</a></code> functions return
a list two elements for each stochastic map:<br>
- <code>$phylo</code>: a phylogenetic tree with added non-bifurcating
nodes<br>
- <code>$node_area</code>: a data frame with the node area for each
added node. If the argument <code>node_area</code> is not NULL, all the
node area are included in the data frame.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># insert_nodes -----------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">bsm_tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/insert_nodes.html">insert_nodes</a></span><span class="op">(</span></span>
<span>  tree <span class="op">=</span> <span class="va">akodon_newick</span>, </span>
<span>  inserts <span class="op">=</span> <span class="va">insert_list</span>, </span>
<span>  node_area <span class="op">=</span> <span class="va">node_area_list</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `aes_()` was deprecated in ggplot2 3.0.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use tidy evaluation idioms with `aes()`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">ggtree</span> package.</span></span>
<span><span class="co">#&gt;   Please report the issue at <span style="color: #0000BB; font-style: italic;">&lt;https://github.com/YuLab-SMU/ggtree/issues&gt;</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span><span class="co">#&gt; Warning in fortify(data, ...): Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic arguments:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> as.Date = as.Date</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> yscale_mapping = yscale_mapping</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> hang = hang</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span></code></pre></div>
<p>Note that the phylogenies for each BSM output has different number of
internal nodes. Also note that there are more internal nodes than tips,
which means there are non-bifurcating nodes (or singleton nodes).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bsm_tree</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">phylo</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Phylogenetic tree with 30 tips and 52 internal nodes.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tip labels:</span></span>
<span><span class="co">#&gt;   A_mimus, A_lindberghi, A_subfuscus, A_lutescens, A_sylvanus, A_boliviensis, ...</span></span>
<span><span class="co">#&gt; Node labels:</span></span>
<span><span class="co">#&gt;   N31, N32, N33, N34, N35, N36, ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Rooted; includes branch length(s).</span></span>
<span><span class="va">bsm_tree</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">phylo</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Phylogenetic tree with 30 tips and 48 internal nodes.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tip labels:</span></span>
<span><span class="co">#&gt;   A_mimus, A_lindberghi, A_subfuscus, A_lutescens, A_sylvanus, A_boliviensis, ...</span></span>
<span><span class="co">#&gt; Node labels:</span></span>
<span><span class="co">#&gt;   N31, N32, N33, N34, N35, N36, ...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Rooted; includes branch length(s).</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-herodotools-analyses">Run {Herodotools} analyses<a class="anchor" aria-label="anchor" href="#run-herodotools-analyses"></a>
</h3>
<p>Now, we are going to calculate the metrics in {Herodotools}. Before
it, let’s prepare the data. For that we are going to separate the
coordinates from the presence-absence data in the
<code>akodon_sites</code>. Then we will load the evoregions of the
sites.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># separate coords from presence-absence</span></span>
<span></span>
<span><span class="va">site_xy</span> <span class="op">&lt;-</span> <span class="va">akodon_sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">LONG</span>, <span class="va">LAT</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">akodon_pa</span> <span class="op">&lt;-</span> <span class="va">akodon_sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">LONG</span>, <span class="op">-</span><span class="va">LAT</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># filter data in communities based on the species in the phylogeny</span></span>
<span><span class="va">spp_in_tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">akodon_pa</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">akodon_newick</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="va">akodon_pa_tree</span> <span class="op">&lt;-</span> <span class="va">akodon_pa</span><span class="op">[</span>, <span class="va">spp_in_tree</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co"># load evoregion and prepare data</span></span>
<span></span>
<span><span class="va">evoreg_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"regions_results.RData"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load 'regions' object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">evoreg_path</span><span class="op">)</span></span>
<span><span class="va">site_region</span> <span class="op">&lt;-</span> <span class="va">regions</span><span class="op">$</span><span class="va">Cluster_Evoregions</span></span>
<span><span class="va">evoregion_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">site_xy</span>, <span class="va">site_region</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># for visualization </span></span>
<span><span class="va">coastline</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_coastline.html" class="external-link">ne_coastline</a></span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">map_limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">95</span>, <span class="op">-</span><span class="fl">30</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">55</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="age-of-arrival">Age of arrival<a class="anchor" aria-label="anchor" href="#age-of-arrival"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">biogeo_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>biogeo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">chartr</a></span><span class="op">(</span><span class="st">"12345"</span>, <span class="st">"ABCDE"</span>, <span class="va">evoregion_df</span><span class="op">$</span><span class="va">site_region</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># calculating age arrival </span></span>
<span><span class="va">l_age_comm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bsm_tree</span>, <span class="kw">function</span><span class="op">(</span><span class="va">bsm_map</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">tree</span> <span class="op">&lt;-</span> <span class="va">bsm_map</span><span class="op">$</span><span class="va">phylo</span></span>
<span>  <span class="co">#tree$node.label &lt;- NULL</span></span>
<span>  <span class="va">anc_area</span> <span class="op">&lt;-</span> <span class="va">bsm_map</span><span class="op">$</span><span class="va">node_area</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_age_arrival.html">calc_age_arrival</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon_pa_tree</span>, </span>
<span>                                tree <span class="op">=</span> <span class="va">tree</span>, </span>
<span>                                ancestral.area <span class="op">=</span> <span class="va">anc_area</span>, </span>
<span>                                biogeo <span class="op">=</span> <span class="va">biogeo_area</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Organize results</span></span>
<span><span class="va">age_bsm_mtx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>  <span class="va">l_age_comm</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean_age_per_assemblage</span><span class="op">$</span><span class="va">mean_age_arrival</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize results</span></span>
<span></span>
<span><span class="va">bsm_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">evoregion_df</span>, </span>
<span>  age_bsm_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">age_bsm_mtx</span><span class="op">)</span>,</span>
<span>  age_bsm_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">age_bsm_mtx</span>, <span class="fl">1</span>, <span class="va">sd</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualization </span></span>
<span></span>
<span></span>
<span><span class="co"># create a theme</span></span>
<span></span>
<span><span class="va">theme_htools</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span>,</span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>,</span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2.3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                                        direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                                        ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                                        title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                                        label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                                        title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>, </span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">bsm_metrics</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">age_bsm_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://jakubnowosad.com/rcartocolor/reference/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"quantitative"</span>, </span>
<span>                                  palette <span class="op">=</span> <span class="st">"SunsetDark"</span>,</span>
<span>                                  direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Mean age (Myr)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_htools</span></span></code></pre></div>
<p><img src="bsm_analysis_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">bsm_metrics</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">age_bsm_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://jakubnowosad.com/rcartocolor/reference/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"quantitative"</span>, </span>
<span>                                  palette <span class="op">=</span> <span class="st">"BrwnYl"</span>,</span>
<span>                                  direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"SD age (Myr)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">theme_htools</span></span></code></pre></div>
<p><img src="bsm_analysis_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References:<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Dupin, J., Matzke, N. J., Särkinen, T., Knapp, S., Olmstead, R. G.,
Bohs, L., &amp; Smith, S. D. (2017). Bayesian estimation of the global
biogeographical history of the Solanaceae. Journal of Biogeography,
44(4), 887–899. <a href="https://doi.org/10.1111/jbi.12898" class="external-link uri">https://doi.org/10.1111/jbi.12898</a>
</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gabriel Nakamura, Arthur Rodrigues, André Luza, Vanderlei Debastiani, Renan Maestri, Leandro Duarte.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
