<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to Herodotools • Herodotools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Herodotools">
<meta property="og:description" content="Herodotools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Herodotools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Intro_Herodotools_vignette.html">Introduction to Herodotools</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Intro_Herodotools_vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to Herodotools</h1>
            
            <h4 data-toc-skip class="date">2022-11-21</h4>
      
      
      <div class="hidden name"><code>Intro_Herodotools_vignette.Rmd</code></div>

    </div>

    
    
<p>In this article we will show the main functions of <code>Herodotools</code>. To do so we will evaluate the effects of deep past processes, represented by diversification and historical dispersal, on the structure and phenotype of assemblages of species from the genus <em>Akodon</em>.</p>
<p>For this aim we will perform the following steps:</p>
<ol style="list-style-type: decimal">
<li>
<a href="#processing">Process</a> raw occurrence data and phylogenetic information</li>
<li>
<a href="#evoregions">Classify</a> Akodon assemblages in meaningful regions using <code>evoregion</code> function</li>
<li>
<a href="#modelBasedMetrics">Calculate</a> macroevolutionary model-based metrics of diversification using an ancestral state reconstruction model</li>
<li>
<a href="#phylomodelmetricscomm">Calculate</a> model-based community phylogenetic metrics</li>
<li>
<a href="#traitdynamics">Calculate</a> ti/model-based metrics of trait macroevolutionary dynamics</li>
</ol>
<div class="section level2">
<h2 id="reading-data-and-libraries">Reading data and libraries<a class="anchor" aria-label="anchor" href="#reading-data-and-libraries"></a>
</h2>
<p>First, let’s read some libraries we will use to explore the data and produce the figures</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">picante</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Nowosad/rcartocolor" class="external-link">rcartocolor</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span></code></pre></div>
<p>If you do not have Herodotools installed use the following code to install the package from github repository:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"GabrielNakamura/Herodotools"</span>, ref <span class="op">=</span> <span class="st">"main"</span><span class="op">)</span></span></code></pre></div>
<p>To read the files corresponding to the distribution of species, phylogenetic relationship and trait values (represented by body size) type:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gabrielnakamura.github.io/Herodotools/">Herodotools</a></span><span class="op">)</span></span>
<span><span class="va">akodon.sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Table_Akodon_coords_pa.txt"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span>, </span>
<span>                           header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">akodon.newick</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">read.tree</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"akodon.new"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="processing">Data processing<a class="anchor" aria-label="anchor" href="#processing"></a>
</h2>
<p>Here we will perform a few data processing in order to get spatial and occurrence information</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site.xy</span> <span class="op">&lt;-</span> <span class="va">akodon.sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">LONG</span>, <span class="va">LAT</span><span class="op">)</span></span>
<span></span>
<span><span class="va">akodon.pa</span> <span class="op">&lt;-</span> <span class="va">akodon.sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">LONG</span>, <span class="op">-</span><span class="va">LAT</span><span class="op">)</span></span></code></pre></div>
<p>Checking if species names between occurrence matrix and phylogenetic tree are matching</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spp.in.tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">akodon.pa</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">akodon.newick</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="va">akodon.pa.tree</span> <span class="op">&lt;-</span> <span class="va">akodon.pa</span><span class="op">[</span>, <span class="va">spp.in.tree</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-spatial-patterns">Exploring spatial patterns<a class="anchor" aria-label="anchor" href="#exploring-spatial-patterns"></a>
</h2>
<p>Here we can observe the richness pattern for Akodon genus</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>coastline &lt;-<span class="st"> </span>rnaturalearth<span class="op">::</span><span class="kw">ne_coastline</span>(<span class="dt">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>map.limits &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="dt">x =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">95</span>, <span class="dv">-30</span>),</span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="dt">y =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">55</span>, <span class="dv">12</span>)</span>
<span id="cb6-5"><a href="#cb6-5"></a>)</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>rich.tree &lt;-<span class="st"> </span><span class="kw">rowSums</span>(akodon.pa.tree)</span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>map_rich_tree &lt;-<span class="st"> </span></span>
<span id="cb6-10"><a href="#cb6-10"></a>dplyr<span class="op">::</span><span class="kw">bind_cols</span>(site.xy, <span class="dt">rich.tree =</span> rich.tree) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> rich.tree)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="st">  </span>rcartocolor<span class="op">::</span><span class="kw">scale_fill_carto_c</span>(<span class="dt">name =</span> <span class="st">"Richness"</span>, <span class="dt">type =</span> <span class="st">"quantitative"</span>, <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>) <span class="op">+</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline) <span class="op">+</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"Richness for Akodon Genus"</span>) <span class="op">+</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>()</span></code></pre></div>
<p><img src="Fig1_richmap_akodon.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="evoregions">Obtaining evoregions<a class="anchor" aria-label="anchor" href="#evoregions"></a>
</h2>
<p>Here we will use the function <code>evoregion</code>, originally described in <a href="https://besjournals.onlinelibrary.wiley.com/doi/abs/10.1111/2041-210X.13492" class="external-link">Maestri and Duarte (2020)</a>, and implemented in Herodotools package. This method of classification allows to perform a biogeographical regionalization based on a <a href="https://doi.org/10.1111/2041-210X.12547" class="external-link">phylogenetic fuzzy matrix</a> coupled with a <a href="https://bmcgenomdata.biomedcentral.com/articles/10.1186/1471-2156-11-94" class="external-link">Discriminant Analysis of Principal Components based on k-means non-hierarchical clustering</a>. Evoregions can be viewed as areas that correspond to centers of independent diversification of lineages, reflecting the historical radiation of single clades.</p>
<p>To calculate evoregions we need the occurrence matrix, a phylogenetic tree and to define the maximum number of clusters allowed for the group being analyzed. If the user decided to not inform the maximum number of clusters, evoregion function will perform an automatic procedure based on “elbow” method to set the maximum number of clusters. The “elbow” method is implemented in package <a href="https://besjournals.onlinelibrary.wiley.com/doi/epdf/10.1111/2041-210X.13478" class="external-link"><code>phyloregion</code></a>. It is worth note that the original proposition of evoregion method use a bootstrapt method to define the maximmun number of clusters to be used in the analysis. Here we opted to use the “elbow” method mainly due to computational speed, since this method is faster than the bootstrap-based method.</p>
<p><strong>NOTE</strong>: The regions obtained from will present different names at each time that the analysis be performed, but the patterns will be the same. Consequently, if the user run the same code the evoregions will appear with different names.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regions</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/evoregions.html">evoregions</a></span><span class="op">(</span></span>
<span>  comm <span class="op">=</span> <span class="va">akodon.pa.tree</span>,</span>
<span>  phy <span class="op">=</span> <span class="va">akodon.newick</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">site.region</span> <span class="op">&lt;-</span> <span class="va">regions</span><span class="op">$</span><span class="va">Cluster_Evoregions</span></span></code></pre></div>
<p>We have to transform the evoregion results to spatial object in order to visualize in a map the regions. This can be done using the following code:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">evoregion.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  <span class="va">site.xy</span>, </span>
<span>  <span class="va">site.region</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">r.evoregion</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">evoregion.df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Converting evoregion to a spatial polygon data frame, so it can be plotted</span></span>
<span><span class="va">sf.evoregion</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.spatvector.html" class="external-link">as.polygons</a></span><span class="op">(</span><span class="va">r.evoregion</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Downloading coastline continents and croping to keep only South America</span></span>
<span><span class="va">coastline</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu">ne_coastline</span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">map.limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">95</span>, <span class="op">-</span><span class="fl">30</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">55</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assigning the same projection to both spatial objects</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">sf.evoregion</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">coastline</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Colours to plot evoregions</span></span>
<span><span class="va">col_five_hues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"#3d291a"</span>,</span>
<span>  <span class="st">"#a9344f"</span>,</span>
<span>  <span class="st">"#578a5b"</span>,</span>
<span>  <span class="st">"#83a6c4"</span>,</span>
<span>  <span class="st">"#fcc573"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Evoregions can now be mapped using the following code</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a></span>
<span id="cb9-2"><a href="#cb9-2"></a>map_evoregion &lt;-<span class="st"> </span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span>evoregion.df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> site.region)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">scale_fill_manual</span>(</span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="dt">name =</span> <span class="st">""</span>, </span>
<span id="cb9-8"><a href="#cb9-8"></a>    <span class="dt">labels =</span> LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>],</span>
<span id="cb9-9"><a href="#cb9-9"></a>    <span class="dt">values =</span> <span class="kw">rev</span>(col_five_hues)</span>
<span id="cb9-10"><a href="#cb9-10"></a>  ) <span class="op">+</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline) <span class="op">+</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb9-13"><a href="#cb9-13"></a>    <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb9-14"><a href="#cb9-14"></a>    <span class="dt">color =</span> <span class="st">"#040400"</span>,</span>
<span id="cb9-15"><a href="#cb9-15"></a>    <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb9-16"><a href="#cb9-16"></a>    <span class="dt">size =</span> <span class="fl">0.2</span>) <span class="op">+</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"A"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb9-21"><a href="#cb9-21"></a>    <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb9-22"><a href="#cb9-22"></a>    <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb9-23"><a href="#cb9-23"></a>    <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">5</span>),</span>
<span id="cb9-24"><a href="#cb9-24"></a>    <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb9-25"><a href="#cb9-25"></a>    <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">family =</span> <span class="st">"Arial"</span>, <span class="dt">color =</span> <span class="st">"black"</span>, <span class="dt">size =</span> <span class="dv">8</span>)</span>
<span id="cb9-26"><a href="#cb9-26"></a>  )</span></code></pre></div>
<p><img src="Fig2_evoregion_akodon.png"><!-- --></p>
<p><code>evoregion</code> produced five distinct regions, but not all cells have the same degree of affiliation in associated with the region in which it was classified. Cells with high affiliation indicates assemblages that are more similar to all the other cells presented in the region, on the other hand assemblages with low values of affiliation correspond to <a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13492" class="external-link">turnover areas</a>, in other words, areas with multiple events of colonization by different lineages.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Selecting only axis with more than 5% of explained variance from evoregion output</span></span>
<span><span class="va">axis_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">regions</span><span class="op">$</span><span class="va">PCPS</span><span class="op">$</span><span class="va">prop_explainded</span> <span class="op">&gt;=</span> <span class="va">regions</span><span class="op">$</span><span class="va">PCPS</span><span class="op">$</span><span class="va">tresh_dist</span><span class="op">)</span></span>
<span><span class="va">PCPS_thresh</span> <span class="op">&lt;-</span> <span class="va">regions</span><span class="op">$</span><span class="va">PCPS</span><span class="op">$</span><span class="va">vectors</span><span class="op">[</span>, <span class="va">axis_sel</span><span class="op">]</span> </span>
<span></span>
<span><span class="co"># distance matrix using 4 significant PCPS axis accordingly to the 5% threshold </span></span>
<span><span class="va">dist_phylo_PCPS</span> <span class="op">&lt;-</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/vegan/man/vegdist.html" class="external-link">vegdist</a></span><span class="op">(</span><span class="va">PCPS_thresh</span>, method <span class="op">=</span> <span class="st">"euclidean"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating affiliation values for each assemblage </span></span>
<span><span class="va">afi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/affiliation_evoreg.html">affiliation_evoreg</a></span><span class="op">(</span>phylo.comp.dist <span class="op">=</span> <span class="va">dist_phylo_PCPS</span>,</span>
<span>                          groups <span class="op">=</span> <span class="va">regions</span><span class="op">$</span><span class="va">Cluster_Evoregions</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># binding the information in a data frame</span></span>
<span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site.xy</span>, site.region <span class="op">=</span>  <span class="va">site.region</span>, <span class="va">afi</span><span class="op">)</span></span></code></pre></div>
<p>Now we can map both evoregions and the affiliation of each cell. The degree of affiliation of cells are showed as the degree of fade for each color. As fade the color of the cell, lesser the affiliation of that cell to its evoregion. Those cell can be interpreted as being zones of high phylogenetic turnover.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>map_joint_evoregion_afilliation &lt;-<span class="st"> </span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">   </span>evoregion.df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="st">   </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> site.region), </span>
<span id="cb11-5"><a href="#cb11-5"></a>               <span class="dt">alpha =</span> sites[, <span class="st">"afilliation"</span>]) <span class="op">+</span><span class="st"> </span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">scale_fill_manual</span>(</span>
<span id="cb11-7"><a href="#cb11-7"></a>     <span class="dt">name =</span> <span class="st">""</span>, </span>
<span id="cb11-8"><a href="#cb11-8"></a>     <span class="dt">labels =</span> LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>],</span>
<span id="cb11-9"><a href="#cb11-9"></a>     <span class="dt">values =</span> <span class="kw">rev</span>(col_five_hues)</span>
<span id="cb11-10"><a href="#cb11-10"></a>   ) <span class="op">+</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb11-13"><a href="#cb11-13"></a>     <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb11-14"><a href="#cb11-14"></a>     <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb11-15"><a href="#cb11-15"></a>     <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb11-16"><a href="#cb11-16"></a>     <span class="dt">size =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"Evoregion and afilliation for Akodon Genus"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="st">   </span><span class="kw">guides</span>(<span class="kw">guide_legend</span>(<span class="dt">direction =</span> <span class="st">"vertical"</span>)) <span class="op">+</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="st">   </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb11-22"><a href="#cb11-22"></a>     <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb11-23"><a href="#cb11-23"></a>     <span class="dt">axis.title =</span> <span class="kw">element_blank</span>()</span>
<span id="cb11-24"><a href="#cb11-24"></a>   )</span></code></pre></div>
<p><img src="Fig3_afilliation_akodon.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="mergeMacroAssemblage">Ancestral area reconstruction for Akodon species<a class="anchor" aria-label="anchor" href="#mergeMacroAssemblage"></a>
</h2>
<p>In this section we will show how Herodotools can use the results that comes from macroevolutionary analysis, particularly analysis of ancestral state reconstruction, to understand the role of diversification and historical dispersal at assemblage level. For this we will use an ancestral area reconstruction performed using <a href="https://github.com/nmatzke/BioGeoBEARS" class="external-link">BioGeoBEARS</a>, a tool commonly used in macroevolution studies.</p>
<p>First, we have to define the membership of each species regarding the evoregions. This will correspond to the current area of species.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">akodon.evoregion.data</span> <span class="op">&lt;-</span> </span>
<span>  <span class="co"># bind compostion matrix and the site evoregion</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span></span>
<span>    <span class="va">akodon.pa.tree</span>,</span>
<span>    site.region <span class="op">=</span>  <span class="va">site.region</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># transform the matrix in a longer dataframe </span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, </span>
<span>    names_to <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"presence"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># filter only the rows with the presence of a species</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">presence</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Count the number of sites in a region that a species is present</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">site.region</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Calculate the propotional area of a species in each region</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    species.total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, </span>
<span>    prec.occupation <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="va">species.total</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Filter for each species the evoregions with more than 25% of area ocupied </span></span>
<span>  <span class="co"># by the species</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">prec.occupation</span> <span class="op">&gt;=</span> <span class="fl">.25</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    area <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="va">site.region</span><span class="op">]</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">area</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> value <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># transform in a dataframe with species in rows and areas ocupied [0-1] in columns</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span></span>
<span>    id_cols <span class="op">=</span> <span class="va">species</span>,</span>
<span>    names_from <span class="op">=</span> <span class="va">area</span>, </span>
<span>    names_sort <span class="op">=</span> <span class="cn">T</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">value</span>,</span>
<span>    values_fill <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">species.names</span> <span class="op">&lt;-</span> <span class="va">akodon.evoregion.data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">a.regions</span> <span class="op">&lt;-</span> <span class="va">akodon.evoregion.data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">a.regions</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">species.names</span></span></code></pre></div>
<p>The object created in the last step can be used in an auxiliary function present in Herodotools to easily produce the <a href="http://scikit-bio.org/docs/0.2.3/generated/skbio.io.phylip.html" class="external-link">Phyllip</a> file required to run the analysis of ancestral area reconstruction using BioGeoBEARS.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save phyllip file</span></span>
<span><span class="fu"><a href="../reference/tipranges_to_BioGeoBEARS.html">tipranges_to_BioGeoBEARS</a></span><span class="op">(</span></span>
<span>  <span class="va">a.regions</span>, </span>
<span>  <span class="co"># please set a new path to save the file</span></span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"inst"</span>, <span class="st">"extdata"</span>, <span class="st">"geo_area_akodon.data"</span><span class="op">)</span>,</span>
<span>  areanames <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Since it take some time to run BioGeoBEARS (about 15 minutes in a 4GB processor machine), and this is not the objective of this tutorial to show how to run a reconstruction using BioGeoBEARS we can just read a reconstruction model perfomed using DEC model to reconstruct the evoregions. However if you want to see the code we used to run the BioGeoBEARS models, here is the code <code>file.edit(system.file("extdata", "script", "e_01_run_DEC_model.R", package = "Herodotools"))</code>.</p>
<p>Read the file containing the results of DEC model reconstruction:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://phylo.wikidot.com/biogeobears" class="external-link">BioGeoBEARS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ancestral reconstruction</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"resDEC_akodon.RData"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>It is worth to note that the procedures decribed from here will work with any model of ancestral area reconstruction, but for sake of simplicity we decided to use only the <a href="https://revbayes.github.io/tutorials/biogeo/biogeo_intro.html" class="external-link">DEC model</a>.</p>
</div>
<div class="section level2">
<h2 id="modelBasedMetrics">Merging macroevolutionary models with assemblage level metrics<a class="anchor" aria-label="anchor" href="#modelBasedMetrics"></a>
</h2>
<p>Once we have an occurrence data distribution, a biogeographical regionalization (obtained with <code>evoregions</code> function) and the ancestral area reconstruction we can integrate those three information to calculate metrics that represents historical variables at any spatial scale.</p>
<div class="section level3">
<h3 id="age-of-assemblages">Age of assemblages<a class="anchor" aria-label="anchor" href="#age-of-assemblages"></a>
</h3>
<p>Let’s start by calculating the age of each cell considering the macroevolutionary dynamics of occupancy of regions during time. The age here corresponds to the mean arrival time of each species occupying a given assemblage. By arrival time we mean the most ancient ancestor from a lineage that arrived at the assemblage within a region in which the current species occur today. For the original description of this metric see <a href="https://academic.oup.com/biolinnean/article-abstract/134/1/57/6297962" class="external-link">Van Dijk et al. 2021</a></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># converting numbers to character</span></span>
<span><span class="va">biogeo_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>biogeo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">chartr</a></span><span class="op">(</span><span class="st">"12345"</span>, <span class="st">"ABCDE"</span>, <span class="va">evoregion.df</span><span class="op">$</span><span class="va">site.region</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># getting the ancestral range area for each node </span></span>
<span><span class="va">node.area</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/get_node_range_BioGeoBEARS.html">get_node_range_BioGeoBEARS</a></span><span class="op">(</span></span>
<span>    <span class="va">resDEC</span>,</span>
<span>    phyllip.file <span class="op">=</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"inst"</span>, <span class="st">"extdata"</span>, <span class="st">"geo_area_akodon.data"</span><span class="op">)</span>,</span>
<span>    <span class="va">akodon.newick</span>,</span>
<span>    max.range.size <span class="op">=</span> <span class="fl">4</span> </span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating age arrival </span></span>
<span><span class="va">age_comm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/age_arrival.html">age_arrival</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon.pa.tree</span>, </span>
<span>                        tree <span class="op">=</span> <span class="va">akodon.newick</span>, </span>
<span>                        ancestral.area <span class="op">=</span> <span class="va">node.area</span>, </span>
<span>                        biogeo <span class="op">=</span> <span class="va">biogeo_area</span><span class="op">)</span> </span></code></pre></div>
<p>The function <code>age_arrival</code> returns a object containing the mean age for each assemblage. Species in which the transition to the current region occurred between the last ancestor and the present can be dealt in two ways: the default is by represent it as a low arrival value for those species, and another option is to attribute the age corresponding to half of the branch length connecting the ancestor to the present time. Here we adopted the first option.</p>
<p>With mean age for each assemblage we can map the ages for all assemblages</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a></span>
<span id="cb16-2"><a href="#cb16-2"></a>sites &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(site.xy, <span class="dt">site.region =</span>  site.region, <span class="dt">age =</span> age_comm<span class="op">$</span>mean_age_per_assemblage)</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a>map_age &lt;-<span class="st"> </span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="st">  </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> mean_age_arrival)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="st">  </span><span class="kw">scale_fill_carto_c</span>(<span class="dt">type =</span> <span class="st">"quantitative"</span>, </span>
<span id="cb16-9"><a href="#cb16-9"></a>                     <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>,</span>
<span id="cb16-10"><a href="#cb16-10"></a>                     <span class="dt">direction =</span> <span class="dv">1</span>, </span>
<span id="cb16-11"><a href="#cb16-11"></a>                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">3.5</span>),  <span class="co">## max percent overall</span></span>
<span id="cb16-12"><a href="#cb16-12"></a>                     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">3.5</span>, <span class="dt">by =</span> <span class="fl">.5</span>),</span>
<span id="cb16-13"><a href="#cb16-13"></a>                     <span class="dt">labels =</span> glue<span class="op">::</span><span class="kw">glue</span>(<span class="st">"{seq(0, 3.5, by = 0.5)}"</span>)) <span class="op">+</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb16-16"><a href="#cb16-16"></a>    <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb16-17"><a href="#cb16-17"></a>    <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb16-18"><a href="#cb16-18"></a>    <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb16-19"><a href="#cb16-19"></a>    <span class="dt">size =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"B"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-22"><a href="#cb16-22"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"Mean age (Myr)"</span>) <span class="op">+</span></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb16-25"><a href="#cb16-25"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb16-26"><a href="#cb16-26"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb16-27"><a href="#cb16-27"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb16-28"><a href="#cb16-28"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb16-29"><a href="#cb16-29"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb16-30"><a href="#cb16-30"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb16-31"><a href="#cb16-31"></a>    <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb16-32"><a href="#cb16-32"></a>    <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb16-33"><a href="#cb16-33"></a>    <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>), </span>
<span id="cb16-34"><a href="#cb16-34"></a>    <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">5</span>),</span>
<span id="cb16-35"><a href="#cb16-35"></a>    <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb16-36"><a href="#cb16-36"></a>  )</span></code></pre></div>
<p><img src="Fig4_age_akodon.png"><!-- --></p>
</div>
<div class="section level3">
<h3 id="phylomodelmetrics">Model-based diversification metrics<a class="anchor" aria-label="anchor" href="#phylomodelmetrics"></a>
</h3>
<p>We can also calculate measures of diversification considering the macroevolutionary dynamics of ancestor area. The new measures allows to decompose the effects of two macroevolutionary process: in situ diversification and historical dispersal. Here we will illustrate this by calculating a common tip-based diversification measure propposed by <a href="https://doi.org/10.1038/nature11631" class="external-link">Jetz 2012</a> that consists in the inverse of equal-splits measure called Diversification Rate (DR).</p>
<p>We modified the original metric to take into account only the portion of evolutionary history that is associated with the region in which the species currently occupy, this value represent the diversification that occurred due to <em>in situ diversification process</em></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">akodon_diversification</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="../reference/db_diversification.html">db_diversification</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon.pa.tree</span>,</span>
<span>                   tree <span class="op">=</span> <span class="va">akodon.newick</span>, </span>
<span>                   ancestral.area <span class="op">=</span> <span class="va">node.area</span>, </span>
<span>                   biogeo <span class="op">=</span> <span class="va">biogeo_area</span>, </span>
<span>                   diversification <span class="op">=</span> <span class="st">"jetz"</span>,</span>
<span>                   type <span class="op">=</span> <span class="st">"equal.splits"</span><span class="op">)</span></span></code></pre></div>
<p>The result of <code>db_diversification</code> function is composed by a data-frame containing the value of in-situ diversification for each species in each assemblage and a vector with the harmonic mean in-situ diversification for each assemblage. As with age, we can plot the model based diversification metric to look at the spatial patterns of in-situ diversification in Akodon assemblages.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>sites &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(site.xy,</span>
<span id="cb18-2"><a href="#cb18-2"></a>                   <span class="dt">site.region =</span>  site.region,</span>
<span id="cb18-3"><a href="#cb18-3"></a>                   <span class="dt">age =</span> age_comm<span class="op">$</span>mean_age_per_assemblage,</span>
<span id="cb18-4"><a href="#cb18-4"></a>                   <span class="dt">diversification_model_based =</span> akodon_diversification<span class="op">$</span>model_based_Jetz_harmonic_mean_site,</span>
<span id="cb18-5"><a href="#cb18-5"></a>                   <span class="dt">diversification =</span> akodon_diversification<span class="op">$</span>Jetz_harmonic_mean_site)</span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a>map_diversification &lt;-<span class="st"> </span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="st">   </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="st">   </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> diversification)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="st">   </span><span class="kw">scale_fill_carto_c</span>(<span class="dt">type =</span> <span class="st">"quantitative"</span>, <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>) <span class="op">+</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb18-14"><a href="#cb18-14"></a>     <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb18-15"><a href="#cb18-15"></a>     <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb18-16"><a href="#cb18-16"></a>     <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb18-17"><a href="#cb18-17"></a>     <span class="dt">size =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb18-18"><a href="#cb18-18"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb18-19"><a href="#cb18-19"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"Diversification *sensu* Jetz"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="st">   </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="st">   </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"Harmonic mean diversification"</span>) <span class="op">+</span></span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb18-23"><a href="#cb18-23"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb18-24"><a href="#cb18-24"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb18-25"><a href="#cb18-25"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb18-26"><a href="#cb18-26"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb18-27"><a href="#cb18-27"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb18-28"><a href="#cb18-28"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb18-29"><a href="#cb18-29"></a>     <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb18-30"><a href="#cb18-30"></a>     <span class="dt">axis.title =</span> <span class="kw">element_blank</span>()</span>
<span id="cb18-31"><a href="#cb18-31"></a>   )</span>
<span id="cb18-32"><a href="#cb18-32"></a></span>
<span id="cb18-33"><a href="#cb18-33"></a>map_diversification_model_based &lt;-<span class="st"> </span></span>
<span id="cb18-34"><a href="#cb18-34"></a><span class="st">  </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-35"><a href="#cb18-35"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-36"><a href="#cb18-36"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> diversification_model_based)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-37"><a href="#cb18-37"></a><span class="st">  </span><span class="kw">scale_fill_carto_c</span>(<span class="dt">type =</span> <span class="st">"quantitative"</span>,</span>
<span id="cb18-38"><a href="#cb18-38"></a>                     <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>, </span>
<span id="cb18-39"><a href="#cb18-39"></a>                     <span class="dt">direction =</span> <span class="dv">1</span>, </span>
<span id="cb18-40"><a href="#cb18-40"></a>                     <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),  <span class="co">## max percent overall</span></span>
<span id="cb18-41"><a href="#cb18-41"></a>                     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">.25</span>),</span>
<span id="cb18-42"><a href="#cb18-42"></a>                     <span class="dt">labels =</span> glue<span class="op">::</span><span class="kw">glue</span>(<span class="st">"{seq(0, 1, by = 0.25)}"</span>)) <span class="op">+</span></span>
<span id="cb18-43"><a href="#cb18-43"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb18-44"><a href="#cb18-44"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb18-45"><a href="#cb18-45"></a>    <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb18-46"><a href="#cb18-46"></a>    <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb18-47"><a href="#cb18-47"></a>    <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb18-48"><a href="#cb18-48"></a>    <span class="dt">size =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb18-49"><a href="#cb18-49"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb18-50"><a href="#cb18-50"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"C"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb18-51"><a href="#cb18-51"></a><span class="st">  </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb18-52"><a href="#cb18-52"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"In-situ diversification"</span>) <span class="op">+</span></span>
<span id="cb18-53"><a href="#cb18-53"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb18-54"><a href="#cb18-54"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb18-55"><a href="#cb18-55"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb18-56"><a href="#cb18-56"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb18-57"><a href="#cb18-57"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb18-58"><a href="#cb18-58"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb18-59"><a href="#cb18-59"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb18-60"><a href="#cb18-60"></a>    <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb18-61"><a href="#cb18-61"></a>    <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb18-62"><a href="#cb18-62"></a>    <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>), </span>
<span id="cb18-63"><a href="#cb18-63"></a>    <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">5</span>),</span>
<span id="cb18-64"><a href="#cb18-64"></a>    <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb18-65"><a href="#cb18-65"></a>  )</span>
<span id="cb18-66"><a href="#cb18-66"></a></span>
<span id="cb18-67"><a href="#cb18-67"></a></span>
<span id="cb18-68"><a href="#cb18-68"></a>map_diversification_complete &lt;-<span class="st"> </span>map_diversification <span class="op">+</span><span class="st"> </span>map_diversification_model_based</span></code></pre></div>
<p><img src="Fig5_diversification_akodon.png"><!-- --></p>
</div>
</div>
<div class="section level2">
<h2 id="historical-dispersal-events">Historical dispersal events<a class="anchor" aria-label="anchor" href="#historical-dispersal-events"></a>
</h2>
<p>We can also calculate the importance of dispersal events related to each ancestral range. By using the function <code>dispersal_from</code> we can quantify the contribution of a given ancestral range to historical dispersal of the species in an assemblage. This is done by calculating the proportion of species in an assemblage that dispersed from the focal ancestral range. This calculation is done accounting only for the species that have events of dispersal in its ancestral lineage.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">akodon_dispersal</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="../reference/dispersal_from.html">dispersal_from</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon.pa.tree</span>,</span>
<span>               tree <span class="op">=</span> <span class="va">akodon.newick</span>, </span>
<span>               ancestral.area <span class="op">=</span> <span class="va">node.area</span>, </span>
<span>               biogeo <span class="op">=</span> <span class="va">biogeo_area</span><span class="op">)</span></span></code></pre></div>
<p>We also can map the contribution of dispersal for all regions. Note that the area of ancestral range focused in each map have no values of dipersal from, since it is the source of dispersal to the other regions.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a></span>
<span id="cb20-2"><a href="#cb20-2"></a>sites &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(site.xy,</span>
<span id="cb20-3"><a href="#cb20-3"></a>                   <span class="dt">site.region =</span>  site.region, </span>
<span id="cb20-4"><a href="#cb20-4"></a>                   <span class="dt">age =</span> age_comm<span class="op">$</span>mean_age_per_assemblage,</span>
<span id="cb20-5"><a href="#cb20-5"></a>                   <span class="dt">diversification =</span> akodon_diversification<span class="op">$</span>Jetz_harmonic_mean_site,</span>
<span id="cb20-6"><a href="#cb20-6"></a>                   <span class="dt">diversification_model_based =</span> akodon_diversification<span class="op">$</span>model_based_Jetz_harmonic_mean_site,</span>
<span id="cb20-7"><a href="#cb20-7"></a>                   <span class="dt">dispersal.D =</span> akodon_dispersal[,<span class="dv">1</span>], </span>
<span id="cb20-8"><a href="#cb20-8"></a>                   <span class="dt">dispersal.A =</span> akodon_dispersal[, <span class="dv">2</span>],</span>
<span id="cb20-9"><a href="#cb20-9"></a>                   <span class="dt">dispersal.E =</span> akodon_dispersal[, <span class="dv">3</span>],</span>
<span id="cb20-10"><a href="#cb20-10"></a>                   <span class="dt">dispersal.BD =</span> akodon_dispersal[, <span class="dv">4</span>],</span>
<span id="cb20-11"><a href="#cb20-11"></a>                   <span class="dt">dispersal.B =</span> akodon_dispersal[, <span class="dv">5</span>])</span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a>map_dispersal_D &lt;-<span class="st"> </span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="st">   </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="st">   </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> dispersal.D)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="st">      </span><span class="kw">scale_fill_carto_c</span>(</span>
<span id="cb20-18"><a href="#cb20-18"></a>     <span class="dt">type =</span> <span class="st">"quantitative"</span>, <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>, <span class="dt">na.value =</span> <span class="st">"white"</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb20-19"><a href="#cb20-19"></a>     ) <span class="op">+</span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb20-22"><a href="#cb20-22"></a>     <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb20-23"><a href="#cb20-23"></a>     <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb20-24"><a href="#cb20-24"></a>     <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb20-25"><a href="#cb20-25"></a>     <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb20-26"><a href="#cb20-26"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb20-27"><a href="#cb20-27"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"From D"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-28"><a href="#cb20-28"></a><span class="st">   </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb20-29"><a href="#cb20-29"></a><span class="st">   </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"% of contribution"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-30"><a href="#cb20-30"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb20-31"><a href="#cb20-31"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb20-32"><a href="#cb20-32"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb20-33"><a href="#cb20-33"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb20-34"><a href="#cb20-34"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb20-35"><a href="#cb20-35"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb20-36"><a href="#cb20-36"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb20-37"><a href="#cb20-37"></a>     <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb20-38"><a href="#cb20-38"></a>     <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb20-39"><a href="#cb20-39"></a>     <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>), </span>
<span id="cb20-40"><a href="#cb20-40"></a>     <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">5</span>),</span>
<span id="cb20-41"><a href="#cb20-41"></a>     <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)   </span>
<span id="cb20-42"><a href="#cb20-42"></a>   )</span>
<span id="cb20-43"><a href="#cb20-43"></a></span>
<span id="cb20-44"><a href="#cb20-44"></a>map_dispersal_A &lt;-<span class="st"> </span></span>
<span id="cb20-45"><a href="#cb20-45"></a><span class="st">   </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-46"><a href="#cb20-46"></a><span class="st">   </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-47"><a href="#cb20-47"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> dispersal.A)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-48"><a href="#cb20-48"></a><span class="st">      </span><span class="kw">scale_fill_carto_c</span>(</span>
<span id="cb20-49"><a href="#cb20-49"></a>     <span class="dt">type =</span> <span class="st">"quantitative"</span>, <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>, <span class="dt">na.value =</span> <span class="st">"white"</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb20-50"><a href="#cb20-50"></a>     ) <span class="op">+</span></span>
<span id="cb20-51"><a href="#cb20-51"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb20-52"><a href="#cb20-52"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb20-53"><a href="#cb20-53"></a>     <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb20-54"><a href="#cb20-54"></a>     <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb20-55"><a href="#cb20-55"></a>     <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb20-56"><a href="#cb20-56"></a>     <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb20-57"><a href="#cb20-57"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb20-58"><a href="#cb20-58"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"From A"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-59"><a href="#cb20-59"></a><span class="st">   </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb20-60"><a href="#cb20-60"></a><span class="st">   </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"% of contribution"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-61"><a href="#cb20-61"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb20-62"><a href="#cb20-62"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb20-63"><a href="#cb20-63"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb20-64"><a href="#cb20-64"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb20-65"><a href="#cb20-65"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb20-66"><a href="#cb20-66"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb20-67"><a href="#cb20-67"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb20-68"><a href="#cb20-68"></a>     <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb20-69"><a href="#cb20-69"></a>     <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb20-70"><a href="#cb20-70"></a>     <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>), </span>
<span id="cb20-71"><a href="#cb20-71"></a>     <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">5</span>),</span>
<span id="cb20-72"><a href="#cb20-72"></a>     <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)   </span>
<span id="cb20-73"><a href="#cb20-73"></a>   )</span>
<span id="cb20-74"><a href="#cb20-74"></a></span>
<span id="cb20-75"><a href="#cb20-75"></a>map_dispersal_B &lt;-<span class="st"> </span></span>
<span id="cb20-76"><a href="#cb20-76"></a><span class="st">   </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-77"><a href="#cb20-77"></a><span class="st">   </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-78"><a href="#cb20-78"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> dispersal.B)) <span class="op">+</span></span>
<span id="cb20-79"><a href="#cb20-79"></a><span class="st">   </span><span class="kw">scale_fill_carto_c</span>(</span>
<span id="cb20-80"><a href="#cb20-80"></a>     <span class="dt">type =</span> <span class="st">"quantitative"</span>, <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>, <span class="dt">na.value =</span> <span class="st">"white"</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb20-81"><a href="#cb20-81"></a>     ) <span class="op">+</span></span>
<span id="cb20-82"><a href="#cb20-82"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb20-83"><a href="#cb20-83"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb20-84"><a href="#cb20-84"></a>     <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb20-85"><a href="#cb20-85"></a>     <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb20-86"><a href="#cb20-86"></a>     <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb20-87"><a href="#cb20-87"></a>     <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb20-88"><a href="#cb20-88"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb20-89"><a href="#cb20-89"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"From B"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb20-90"><a href="#cb20-90"></a><span class="st">   </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb20-91"><a href="#cb20-91"></a><span class="st">   </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"% of contribution"</span>) <span class="op">+</span></span>
<span id="cb20-92"><a href="#cb20-92"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb20-93"><a href="#cb20-93"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb20-94"><a href="#cb20-94"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb20-95"><a href="#cb20-95"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb20-96"><a href="#cb20-96"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb20-97"><a href="#cb20-97"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb20-98"><a href="#cb20-98"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb20-99"><a href="#cb20-99"></a>     <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb20-100"><a href="#cb20-100"></a>     <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb20-101"><a href="#cb20-101"></a>     <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>), </span>
<span id="cb20-102"><a href="#cb20-102"></a>     <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">5</span>),</span>
<span id="cb20-103"><a href="#cb20-103"></a>     <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)   </span>
<span id="cb20-104"><a href="#cb20-104"></a>   )</span>
<span id="cb20-105"><a href="#cb20-105"></a></span>
<span id="cb20-106"><a href="#cb20-106"></a></span>
<span id="cb20-107"><a href="#cb20-107"></a>map_dispersion_from &lt;-<span class="st"> </span></span>
<span id="cb20-108"><a href="#cb20-108"></a><span class="st">  </span>(map_evoregion <span class="op">+</span><span class="st"> </span><span class="kw">plot_layout</span>(<span class="dt">guides =</span> <span class="st">"keep"</span>)) <span class="op">/</span><span class="st"> </span></span>
<span id="cb20-109"><a href="#cb20-109"></a><span class="st">  </span>(map_dispersal_A <span class="op">|</span><span class="st"> </span>map_dispersal_B <span class="op">|</span><span class="st"> </span>map_dispersal_D) <span class="op">+</span></span>
<span id="cb20-110"><a href="#cb20-110"></a><span class="st">  </span><span class="kw">plot_layout</span>(<span class="dt">heights =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">.75</span>), <span class="dt">guides =</span> <span class="st">"collect"</span>) <span class="op">&amp;</span></span>
<span id="cb20-111"><a href="#cb20-111"></a><span class="st">  </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</span></code></pre></div>
<p><img src="Fig5_map_dispersion_from_akodon.png"><!-- --></p>
<div class="section level3">
<h3 id="phylomodelmetricscomm">Model based community phylogetic metrics<a class="anchor" aria-label="anchor" href="#phylomodelmetricscomm"></a>
</h3>
<p>We also can calculate common used metrics in Community Phylogenetics, but now considering the macroevolutionary dynamics in the calculation. These model-based community phylogenetic metrics allows to disentangle the effects of in situ diversification and dispersal</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">akodon_db_metrics</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="../reference/div_based_metrics.html">div_based_metrics</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon.pa.tree</span>,</span>
<span>                  tree <span class="op">=</span> <span class="va">akodon.newick</span>, </span>
<span>                  ancestral.area <span class="op">=</span> <span class="va">node.area</span>, </span>
<span>                  biogeo <span class="op">=</span> <span class="va">biogeo_area</span>, </span>
<span>                  PD <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                  PE <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>As the other metrics we can plot PDdb and PEdb in a map</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>sites &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(site.xy,</span>
<span id="cb22-2"><a href="#cb22-2"></a>                   <span class="dt">site.region =</span>  site.region, </span>
<span id="cb22-3"><a href="#cb22-3"></a>                   <span class="dt">age =</span> age_comm<span class="op">$</span>mean_age_per_assemblage,</span>
<span id="cb22-4"><a href="#cb22-4"></a>                   <span class="dt">diversification =</span> akodon_diversification<span class="op">$</span>Jetz_harmonic_mean_site,</span>
<span id="cb22-5"><a href="#cb22-5"></a>                   <span class="dt">PE =</span> akodon_db_metrics<span class="op">$</span>PE, </span>
<span id="cb22-6"><a href="#cb22-6"></a>                   <span class="dt">PEdb =</span> akodon_db_metrics<span class="op">$</span>Db_PE,</span>
<span id="cb22-7"><a href="#cb22-7"></a>                   <span class="dt">PD =</span> akodon_db_metrics<span class="op">$</span>PD,</span>
<span id="cb22-8"><a href="#cb22-8"></a>                   <span class="dt">PDdb =</span> akodon_db_metrics<span class="op">$</span>PDlocal)</span>
<span id="cb22-9"><a href="#cb22-9"></a></span>
<span id="cb22-10"><a href="#cb22-10"></a>map_PE &lt;-<span class="st"> </span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="st">   </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="st">   </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> PE)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="st">   </span><span class="kw">scale_fill_carto_c</span>(<span class="dt">type =</span> <span class="st">"quantitative"</span>, <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>) <span class="op">+</span></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb22-17"><a href="#cb22-17"></a>     <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb22-18"><a href="#cb22-18"></a>     <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb22-19"><a href="#cb22-19"></a>     <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb22-20"><a href="#cb22-20"></a>     <span class="dt">size =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb22-21"><a href="#cb22-21"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"PE for Akodon Genus"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="st">   </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb22-24"><a href="#cb22-24"></a><span class="st">   </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"PE value"</span>) <span class="op">+</span></span>
<span id="cb22-25"><a href="#cb22-25"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb22-26"><a href="#cb22-26"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb22-27"><a href="#cb22-27"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb22-28"><a href="#cb22-28"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb22-29"><a href="#cb22-29"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb22-30"><a href="#cb22-30"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb22-31"><a href="#cb22-31"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb22-32"><a href="#cb22-32"></a>     <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb22-33"><a href="#cb22-33"></a>     <span class="dt">axis.title =</span> <span class="kw">element_blank</span>()</span>
<span id="cb22-34"><a href="#cb22-34"></a>   )</span>
<span id="cb22-35"><a href="#cb22-35"></a></span>
<span id="cb22-36"><a href="#cb22-36"></a>map_PEdb &lt;-<span class="st"> </span></span>
<span id="cb22-37"><a href="#cb22-37"></a><span class="st">   </span>sites <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-38"><a href="#cb22-38"></a><span class="st">   </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb22-39"><a href="#cb22-39"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> PEdb)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb22-40"><a href="#cb22-40"></a><span class="st">   </span><span class="kw">scale_fill_carto_c</span>(<span class="dt">type =</span> <span class="st">"quantitative"</span>, <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>) <span class="op">+</span></span>
<span id="cb22-41"><a href="#cb22-41"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb22-42"><a href="#cb22-42"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(</span>
<span id="cb22-43"><a href="#cb22-43"></a>     <span class="dt">data =</span> sf.evoregion, </span>
<span id="cb22-44"><a href="#cb22-44"></a>     <span class="dt">color =</span> <span class="kw">rev</span>(col_five_hues),</span>
<span id="cb22-45"><a href="#cb22-45"></a>     <span class="dt">fill =</span> <span class="ot">NA</span>, </span>
<span id="cb22-46"><a href="#cb22-46"></a>     <span class="dt">size =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb22-47"><a href="#cb22-47"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> map.limits<span class="op">$</span>x, <span class="dt">ylim =</span> map.limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb22-48"><a href="#cb22-48"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">ggtitle</span>(<span class="st">"PEdb for Akodon Genus"</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb22-49"><a href="#cb22-49"></a><span class="st">   </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb22-50"><a href="#cb22-50"></a><span class="st">   </span><span class="kw">labs</span>(<span class="dt">fill =</span> <span class="st">"PEdb value"</span>) <span class="op">+</span></span>
<span id="cb22-51"><a href="#cb22-51"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb22-52"><a href="#cb22-52"></a>                               <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb22-53"><a href="#cb22-53"></a>                               <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb22-54"><a href="#cb22-54"></a>                               <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb22-55"><a href="#cb22-55"></a>                               <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb22-56"><a href="#cb22-56"></a>                               <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb22-57"><a href="#cb22-57"></a><span class="st">   </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb22-58"><a href="#cb22-58"></a>     <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb22-59"><a href="#cb22-59"></a>     <span class="dt">axis.title =</span> <span class="kw">element_blank</span>()</span>
<span id="cb22-60"><a href="#cb22-60"></a>   )</span>
<span id="cb22-61"><a href="#cb22-61"></a></span>
<span id="cb22-62"><a href="#cb22-62"></a>map_PEdb &lt;-<span class="st"> </span>map_PE <span class="op">+</span><span class="st"> </span>map_PEdb</span></code></pre></div>
<p><img src="Fig6_map_PEdb.png"><!-- --></p>
</div>
</div>
<div class="section level2">
<h2 id="traitdynamics">Tip-based metrics of trait evolution<a class="anchor" aria-label="anchor" href="#traitdynamics"></a>
</h2>
<p>Here we will show how to implement three tip-based metrics proposed by <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.8476" class="external-link">Luza et al. (2021)</a>. Note that these tip-based metrics were estimated using the stochastic mapping of discrete/categorical traits (diet in the original publication), but can be extended to other traits as we will show here. The three tip-based metrics are <em>Transition rates</em>, <em>Stasis time</em>, and <em>Last transition time</em>, and are implemented in the function <code>tip_based_trait_evo</code>. <em>Transition rates</em> indicate how many times the ancestral character has changed over time. <em>Stasis time</em> indicates the maximum branch length (time interval) which the current tip-character was maintained across the whole phylogeny. Finally, <em>last transition time</em> is the sum of branch lengths from the tip to the prior/previous node with a reconstructed character equal to current tip-character. As in the <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.8476" class="external-link">original publication</a>, we will use the stochastic character mapping on discrete trait data. This time, however, we will reconstruct the species foraging strata (Elton Traits’ database, Wilman et al. 2014). We will reconstruct the foraging strata for 214 sigmodontine rodent species with trait and phylogenetic data (consensus phylogeny of <a href="https://journals.plos.org/plosbiology/article?id=10.1371/journal.pbio.3000494" class="external-link">Upham et al. 2019</a>).</p>
<p>First we will load trait and phylogenetic data we need to run the function <code>tip_based_trait_evo</code>.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rodent.phylo</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.nexus.html" class="external-link">read.nexus</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Sigmodontinae_285speciesTree.tre"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="co"># traits</span></span>
<span><span class="va">traits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"MamFuncDat.txt"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">T</span>, sep <span class="op">=</span> <span class="st">"\t"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># adjust sciName for matching</span></span>
<span><span class="va">traits</span><span class="op">$</span><span class="va">Scientific</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span> <span class="op">(</span><span class="st">" "</span>, <span class="st">"_"</span>, <span class="va">traits</span><span class="op">$</span><span class="va">Scientific</span><span class="op">)</span></span>
<span><span class="va">traits</span> <span class="op">&lt;-</span> <span class="va">traits</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">traits</span><span class="op">$</span><span class="va">Scientific</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">rodent.phylo</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span>, <span class="op">]</span> <span class="co"># subset</span></span>
<span><span class="va">traits</span> <span class="op">&lt;-</span> <span class="va">traits</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">rodent.phylo</span><span class="op">$</span><span class="va">tip.label</span>,<span class="va">traits</span><span class="op">$</span><span class="va">Scientific</span><span class="op">)</span>, <span class="op">]</span> <span class="co"># match to have the same order</span></span>
<span><span class="va">traits</span> <span class="op">&lt;-</span> <span class="va">traits</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">traits</span><span class="op">$</span><span class="va">Scientific</span><span class="op">)</span> <span class="op">!=</span><span class="cn">T</span>,<span class="op">]</span> <span class="co">#names not matching</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">traits</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">traits</span><span class="op">$</span><span class="va">Scientific</span></span>
<span></span>
<span><span class="co"># match</span></span>
<span><span class="va">match_data</span> <span class="op">&lt;-</span> <span class="fu">picante</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/picante/man/data.checking.html" class="external-link">match.phylo.data</a></span><span class="op">(</span><span class="va">rodent.phylo</span>, <span class="va">traits</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trait</span> <span class="op">&lt;-</span> <span class="va">match_data</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ForStrat.Value</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">trait</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">match_data</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">Scientific</span></span>
<span></span>
<span><span class="co"># run function</span></span>
<span><span class="va">trans_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tip_based_trait_evo.html">tip_based_trait_evo</a></span><span class="op">(</span>tree<span class="op">=</span><span class="va">match_data</span><span class="op">$</span><span class="va">phy</span>,</span>
<span>                                   trait <span class="op">=</span><span class="va">trait</span> , <span class="co"># need to be named to work</span></span>
<span>                                   nsim <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                   method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"transition_rates"</span>, <span class="st">"last_transition_time"</span>, <span class="st">"stasis_time"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we have in hand the estimates of the three tip-based metrics for 214 rodent species. We can summarize the tip-based metrics at the ecological assemblage scale. First we will load assemblage &amp; geographic data comprising 1770 grid cells located at the Neotropics.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># load community data</span></span>
<span><span class="va">comm.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"PresAbs_228sp_Neotropical_MainDataBase_Ordenado.txt"</span>, </span>
<span>               package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span>,</span>
<span>   header <span class="op">=</span> <span class="cn">T</span>, sep <span class="op">=</span> <span class="st">"\t"</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span><span class="co"># load latlong of these communities</span></span>
<span><span class="va">geo.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Lon-lat-Disparity.txt"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">T</span>, sep <span class="op">=</span> <span class="st">"\t"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Now we calculate the values of tip-based metrics for all species for each assemblage.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># transition rates for each community</span></span>
<span><span class="va">averaged_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comm.data</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># across assemblages</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">trans_rates</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op">{</span> <span class="co"># across simulations</span></span>
<span>    </span>
<span>    <span class="co"># species in the assemblages</span></span>
<span>    <span class="va">gather_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span> <span class="op">(</span><span class="va">comm.data</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">comm.data</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co"># get the names</span></span>
<span>    <span class="co"># subset of rates</span></span>
<span>    <span class="va">rates</span> <span class="op">&lt;-</span> <span class="va">sims</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span> <span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">gather_names</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prop.transitions"</span>, </span>
<span>                     <span class="st">"stasis.time"</span>,</span>
<span>                     <span class="st">"last.transition.time"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">mean_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">rates</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># and calculate the average</span></span>
<span>    <span class="va">mean_rates</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We will represent in space the variation in the tip-based metrics for rodent assemblages. It seems that, in general, assemblages of the southern, western and northeastern Neotropics have species with higher Transition Rates in foraging strata than communities from elsewhere (i.e., they have many species that often changed their foraging strata over time). Assemblage-level Stasis Time was high for two groups of assemblages: one from northeastern Neotropics, and another in central Amazonia. The first group in particular also showed high Transition Rates. Taken together, these results indicate that, despite the frequent changes in foraging strata, the species of northeastern assemblages retained their phenotipic state during more time than the species found elsewhere. Finally, the Last Transition Time metric shows that the transitions leading to the present species foraging strata were older in the i) north of the Amazonia and ii) central Mexico. These results are potentially reflecting i) the location of arrival of ancestral sigmodontine rodents in south America, and ii) the occurrence of several species closely related to basal lineages.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="co"># prepare data to map</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>data_to_map_wide &lt;-<span class="st"> </span><span class="kw">data.frame</span>(geo.data[,<span class="kw">c</span>(<span class="st">"LONG"</span>, <span class="st">"LAT"</span>)], averaged_rates)</span>
<span id="cb26-4"><a href="#cb26-4"></a></span>
<span id="cb26-5"><a href="#cb26-5"></a>data_to_map_long &lt;-<span class="st"> </span></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="st">  </span>data_to_map_wide <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="st">  </span><span class="kw">pivot_longer</span>(</span>
<span id="cb26-8"><a href="#cb26-8"></a>    <span class="dt">cols =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">5</span>,</span>
<span id="cb26-9"><a href="#cb26-9"></a>    <span class="dt">names_to =</span> <span class="st">"variables"</span>,</span>
<span id="cb26-10"><a href="#cb26-10"></a>    <span class="dt">values_to =</span> <span class="st">"values"</span></span>
<span id="cb26-11"><a href="#cb26-11"></a>  )</span>
<span id="cb26-12"><a href="#cb26-12"></a></span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="co"># create a list with the maps</span></span>
<span id="cb26-14"><a href="#cb26-14"></a>list_map_transitions &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">unique</span>(data_to_map_long<span class="op">$</span>variables), <span class="cf">function</span>(metric){</span>
<span id="cb26-15"><a href="#cb26-15"></a>  </span>
<span id="cb26-16"><a href="#cb26-16"></a>  plot.title &lt;-<span class="st"> </span><span class="cf">switch</span>(</span>
<span id="cb26-17"><a href="#cb26-17"></a>    metric,</span>
<span id="cb26-18"><a href="#cb26-18"></a>    <span class="st">"prop.transitions"</span> =<span class="st"> "Transition Rates"</span>,</span>
<span id="cb26-19"><a href="#cb26-19"></a>    <span class="st">"stasis.time"</span> =<span class="st"> "Stasis Time"</span>,</span>
<span id="cb26-20"><a href="#cb26-20"></a>    <span class="st">"last.transition.time"</span> =<span class="st"> "Last Transition Time"</span></span>
<span id="cb26-21"><a href="#cb26-21"></a>  )</span>
<span id="cb26-22"><a href="#cb26-22"></a>  </span>
<span id="cb26-23"><a href="#cb26-23"></a>  sel_data &lt;-<span class="st"> </span></span>
<span id="cb26-24"><a href="#cb26-24"></a><span class="st">    </span>data_to_map_long <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb26-25"><a href="#cb26-25"></a><span class="st">    </span><span class="kw">filter</span>(variables <span class="op">==</span><span class="st"> </span>metric)</span>
<span id="cb26-26"><a href="#cb26-26"></a>  </span>
<span id="cb26-27"><a href="#cb26-27"></a>  var_range &lt;-<span class="st"> </span><span class="kw">range</span>(sel_data<span class="op">$</span>values) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</span>
<span id="cb26-28"><a href="#cb26-28"></a>  var_breaks &lt;-<span class="st"> </span><span class="kw">seq</span>(var_range[<span class="dv">1</span>], var_range[<span class="dv">2</span>], <span class="kw">diff</span>(var_range<span class="op">/</span><span class="dv">4</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</span>
<span id="cb26-29"><a href="#cb26-29"></a>  </span>
<span id="cb26-30"><a href="#cb26-30"></a>  sig_map_limits &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb26-31"><a href="#cb26-31"></a>    <span class="dt">x =</span> <span class="kw">range</span>(sel_data<span class="op">$</span>LONG), </span>
<span id="cb26-32"><a href="#cb26-32"></a>    <span class="dt">y =</span> <span class="kw">range</span>(sel_data<span class="op">$</span>LAT)</span>
<span id="cb26-33"><a href="#cb26-33"></a>  )</span>
<span id="cb26-34"><a href="#cb26-34"></a>  </span>
<span id="cb26-35"><a href="#cb26-35"></a>  <span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb26-36"><a href="#cb26-36"></a><span class="st">    </span>ggplot2<span class="op">::</span><span class="kw">geom_raster</span>(<span class="dt">data =</span> sel_data, </span>
<span id="cb26-37"><a href="#cb26-37"></a>                <span class="kw">aes</span>(<span class="dt">x =</span> LONG, <span class="dt">y =</span> LAT, <span class="dt">fill =</span> values)) <span class="op">+</span></span>
<span id="cb26-38"><a href="#cb26-38"></a><span class="st">    </span><span class="kw">scale_fill_carto_c</span>(</span>
<span id="cb26-39"><a href="#cb26-39"></a>      <span class="dt">type =</span> <span class="st">"quantitative"</span>, </span>
<span id="cb26-40"><a href="#cb26-40"></a>      <span class="dt">palette =</span> <span class="st">"SunsetDark"</span>, </span>
<span id="cb26-41"><a href="#cb26-41"></a>      <span class="dt">na.value =</span> <span class="st">"white"</span>, </span>
<span id="cb26-42"><a href="#cb26-42"></a>      <span class="dt">limits =</span> var_range, </span>
<span id="cb26-43"><a href="#cb26-43"></a>      <span class="dt">breaks =</span> var_breaks</span>
<span id="cb26-44"><a href="#cb26-44"></a>    )<span class="op">+</span><span class="st"> </span></span>
<span id="cb26-45"><a href="#cb26-45"></a><span class="st">    </span>ggplot2<span class="op">::</span><span class="kw">geom_sf</span>(<span class="dt">data =</span> coastline, <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb26-46"><a href="#cb26-46"></a><span class="st">    </span>ggplot2<span class="op">::</span><span class="kw">coord_sf</span>(<span class="dt">xlim =</span> sig_map_limits<span class="op">$</span>x, <span class="dt">ylim =</span> sig_map_limits<span class="op">$</span>y) <span class="op">+</span></span>
<span id="cb26-47"><a href="#cb26-47"></a><span class="st">    </span>ggplot2<span class="op">::</span>ggplot2<span class="op">::</span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb26-48"><a href="#cb26-48"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">barheight =</span> <span class="kw">unit</span>(<span class="fl">2.3</span>, <span class="dt">units =</span> <span class="st">"mm"</span>),  </span>
<span id="cb26-49"><a href="#cb26-49"></a>                                 <span class="dt">direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb26-50"><a href="#cb26-50"></a>                                 <span class="dt">ticks.colour =</span> <span class="st">"grey20"</span>,</span>
<span id="cb26-51"><a href="#cb26-51"></a>                                 <span class="dt">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb26-52"><a href="#cb26-52"></a>                                 <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb26-53"><a href="#cb26-53"></a>                                 <span class="dt">title.hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span></span>
<span id="cb26-54"><a href="#cb26-54"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> plot.title) <span class="op">+</span></span>
<span id="cb26-55"><a href="#cb26-55"></a><span class="st">    </span>ggplot2<span class="op">::</span><span class="kw">theme</span>(</span>
<span id="cb26-56"><a href="#cb26-56"></a>      <span class="dt">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb26-57"><a href="#cb26-57"></a>      <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb26-58"><a href="#cb26-58"></a>      <span class="dt">legend.title =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb26-59"><a href="#cb26-59"></a>      <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">10</span>), </span>
<span id="cb26-60"><a href="#cb26-60"></a>      <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">5</span>),</span>
<span id="cb26-61"><a href="#cb26-61"></a>      <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)   </span>
<span id="cb26-62"><a href="#cb26-62"></a>    )</span>
<span id="cb26-63"><a href="#cb26-63"></a>  </span>
<span id="cb26-64"><a href="#cb26-64"></a>})</span>
<span id="cb26-65"><a href="#cb26-65"></a></span>
<span id="cb26-66"><a href="#cb26-66"></a><span class="co"># Create map</span></span>
<span id="cb26-67"><a href="#cb26-67"></a>mapTransition_rate &lt;-<span class="st"> </span><span class="kw">wrap_plots</span>(list_map_transitions) <span class="op">+</span></span>
<span id="cb26-68"><a href="#cb26-68"></a><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">tag_levels =</span> <span class="st">"A"</span>)</span></code></pre></div>
<p><img src="Fig8_map_TransitionRate.png"><!-- --></p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Luza, A. L., Maestri, R., Debastiani, V. J., Patterson, B. D., Maria, S., &amp; Leandro, H. (2021). Is evolution faster at ecotones? A test using rates and tempo of diet transitions in Neotropical Sigmodontinae ( Rodentia , Cricetidae ). Ecology and Evolution, December, 18676–18690. <a href="https://doi.org/10.1002/ece3.8476" class="external-link uri">https://doi.org/10.1002/ece3.8476</a></p></li>
<li><p>Maestri, R., &amp; Duarte, L. D. S. (2020). Evoregions: Mapping shifts in phylogenetic turnover across biogeographic regions Renan Maestri. Methods in Ecology and Evolution, 2020(August), 1652–1662. <a href="https://doi.org/10.1111/2041-210X.13492" class="external-link uri">https://doi.org/10.1111/2041-210X.13492</a></p></li>
<li><p>Van Dijk, A., Nakamura, G., Rodrigues, A. V., Maestri, R., &amp; Duarte, L. (2021b). Imprints of tropical niche conservatism and historical dispersal in the radiation of Tyrannidae (Aves: Passeriformes). Biological Journal of the Linnean Society, 134(1), 57–67. <a href="https://doi.org/10.1093/biolinnean/blab079" class="external-link uri">https://doi.org/10.1093/biolinnean/blab079</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Gabriel Nakamura, Arthur Rodrigues, André Luza, Vanderlei Debastiani, Renan Maestri, Leandro Duarte.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
