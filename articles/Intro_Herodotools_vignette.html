<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Herodotools">
<title>Using Herodotools to analyses of historical biogeography • Herodotools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using Herodotools to analyses of historical biogeography">
<meta property="og:description" content="Herodotools">
<meta property="og:image" content="https://gabrielnakamura.github.io/Herodotools/reference/figures/logo_herodotools.png">
<meta property="og:image:alt" content="Hexagon with upsidown South America Continent with a phylogeny inside and a fish in one of the tips">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@gabrielnakamur4">
<meta name="twitter:site" content="@gabrielnakamur4">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">Herodotools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Intro_Herodotools_vignette.html">Using Herodotools to analyses of historical biogeography</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using Herodotools to analyses of historical biogeography</h1>
            
      
      
      <div class="d-none name"><code>Intro_Herodotools_vignette.Rmd</code></div>
    </div>

    
    
<p>This article will show the main functions of
<code>Herodotools</code>. To do so, we will evaluate the effects of deep
past processes, represented by diversification and historical dispersal,
on the structure and phenotype of species assemblages from the genus
<em>Akodon</em>.</p>
<p>For this aim we will perform the following steps:</p>
<ol style="list-style-type: decimal">
<li>
<a href="#processing">Process</a> raw occurrence data and
phylogenetic information</li>
<li>
<a href="#evoregions">Classify</a> Akodon assemblages in meaningful
regions using <code>evoregion</code> function</li>
<li>
<a href="#modelBasedMetrics">Calculate</a> macroevolutionary
model-based metrics of diversification using an ancestral state
reconstruction model</li>
<li>
<a href="#phylomodelmetricscomm">Calculate</a> model-based community
phylogenetic metrics</li>
<li>
<a href="#traitdynamics">Calculate</a> tip model-based metrics of
trait macroevolutionary dynamics</li>
</ol>
<div class="section level2">
<h2 id="reading-data-and-libraries">Reading data and libraries<a class="anchor" aria-label="anchor" href="#reading-data-and-libraries"></a>
</h2>
<p>First, let’s read some libraries we will use to explore the data and
produce the figures. If you do not have the packages already installed
they will be installed.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">libs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ape"</span>, <span class="st">"picante"</span>, <span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>, <span class="st">"purrr"</span>,</span>
<span>          <span class="st">"raster"</span>, <span class="st">"terra"</span>, <span class="st">"ggplot2"</span>, <span class="st">"stringr"</span>,</span>
<span>          <span class="st">"here"</span>, <span class="st">"sf"</span>, <span class="st">"rnaturalearth"</span>, <span class="st">"rcartocolor"</span>, <span class="st">"patchwork"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="va">libs</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">libs</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>There are two packages that are not in CRAN, daee and BioGeoBEARS,
and are required to run the analysis in this vignette. We suggest to
install and read these packages from github using the following
code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"daee"</span>,<span class="st">"BioGeoBEARS"</span><span class="op">)</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"vanderleidebastiani/daee"</span><span class="op">)</span></span>
<span>  <span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"nmatzke/BioGeoBEARS"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">daee</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://phylo.wikidot.com/biogeobears" class="external-link">BioGeoBEARS</a></span><span class="op">)</span></span></code></pre></div>
<p>Now we need to read the files corresponding to the distribution of
species and phylogenetic relationship that will be used in downstream
analysis with Herodotools</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gabrielnakamura.github.io/Herodotools/">Herodotools</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"akodon_sites"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"akodon_newick"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="processing">Data processing<a class="anchor" aria-label="anchor" href="#processing"></a>
</h2>
<p>Here we will perform a few data processing in order to get spatial
and occurrence information</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site_xy</span> <span class="op">&lt;-</span> <span class="va">akodon_sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">LONG</span>, <span class="va">LAT</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">akodon_pa</span> <span class="op">&lt;-</span> <span class="va">akodon_sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">LONG</span>, <span class="op">-</span><span class="va">LAT</span><span class="op">)</span></span></code></pre></div>
<p>Checking if species names between occurrence matrix and phylogenetic
tree are matching</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spp_in_tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">akodon_pa</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">akodon_newick</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="va">akodon_pa_tree</span> <span class="op">&lt;-</span> <span class="va">akodon_pa</span><span class="op">[</span>, <span class="va">spp_in_tree</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-spatial-patterns">Exploring spatial patterns<a class="anchor" aria-label="anchor" href="#exploring-spatial-patterns"></a>
</h2>
<p>Here we can observe the richness pattern for Akodon genus. For this
we will read the ggplot2 package to produce some maps</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">coastline</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_coastline.html" class="external-link">ne_coastline</a></span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">map_limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">95</span>, <span class="op">-</span><span class="fl">30</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">55</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">richness</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">akodon_pa_tree</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map_richness</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site_xy</span>, richness <span class="op">=</span> <span class="va">richness</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">richness</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Richness"</span>, type <span class="op">=</span> <span class="st">"quantitative"</span>, palette <span class="op">=</span> <span class="st">"SunsetDark"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Longitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Latitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Richness"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>        plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/outFig1-1.png" alt="Figure 1 - Species richness for Akodon genus in South America" width="70%"><p class="caption">
Figure 1 - Species richness for Akodon genus in South America
</p>
</div>
</div>
<div class="section level2">
<h2 id="evoregions">Obtaining evoregions<a class="anchor" aria-label="anchor" href="#evoregions"></a>
</h2>
<p>Here we will use the function <code>calc_evoregion</code>, originally
described in <a href="https://besjournals.onlinelibrary.wiley.com/doi/abs/10.1111/2041-210X.13492" class="external-link">Maestri
and Duarte (2020)</a>, and implemented in Herodotools package. This
method of classification allows to perform a biogeographical
regionalization based on a <a href="https://doi.org/10.1111/2041-210X.12547" class="external-link">phylogenetic fuzzy
matrix</a> coupled with a <a href="https://bmcgenomdata.biomedcentral.com/articles/10.1186/1471-2156-11-94" class="external-link">Discriminant
Analysis of Principal Components based on k-means non-hierarchical
clustering</a>. Evoregions can be viewed as areas that correspond to
centers of independent diversification of lineages, reflecting the
historical radiation of single clades.</p>
<p>To calculate evoregions we need the occurrence matrix, a phylogenetic
tree and to define the maximum number of clusters allowed. If the user
decided to not inform the maximum number of clusters, evoregion function
will perform an automatic procedure based on “elbow” method to set the
maximum number of clusters. The “elbow” method is implemented in package
<a href="https://besjournals.onlinelibrary.wiley.com/doi/epdf/10.1111/2041-210X.13478" class="external-link"><code>phyloregion</code></a>.
It is worth note that the original proposition of evoregion method use a
bootstrap method to define the maximum number of clusters to be used in
the analysis. Here we opted to use the “elbow” method mainly due to
computational speed, since this method is faster than the
bootstrap-based method.</p>
<p><strong>NOTE</strong>: The regions obtained from will present
different names at each time that the analysis be performed, but the
patterns will be the same. Consequently, if the user run the same code
the evoregions will appear with different names, even when specifying an
initial seed for this analysis.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regions</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_evoregions.html">calc_evoregions</a></span><span class="op">(</span></span>
<span>  comm <span class="op">=</span> <span class="va">akodon_pa_tree</span>,</span>
<span>  phy <span class="op">=</span> <span class="va">akodon_newick</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">site_region</span> <span class="op">&lt;-</span> <span class="va">regions</span><span class="op">$</span><span class="va">cluster_evoregions</span></span></code></pre></div>
<p>We have to transform the evoregion results to spatial object in order
to visualize in a map the regions. This can be done using the following
code:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">evoregion_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  <span class="va">site_xy</span>, </span>
<span>  <span class="va">site_region</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">r_evoregion</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">evoregion_df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Converting evoregion to a spatial polygon data frame, so it can be plotted</span></span>
<span><span class="va">sf_evoregion</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.spatvector.html" class="external-link">as.polygons</a></span><span class="op">(</span><span class="va">r_evoregion</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Downloading coastline continents and croping to keep only South America</span></span>
<span><span class="va">coastline</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_coastline.html" class="external-link">ne_coastline</a></span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">map_limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">95</span>, <span class="op">-</span><span class="fl">30</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">55</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assigning the same projection to both spatial objects</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">sf_evoregion</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">coastline</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Colours to plot evoregions</span></span>
<span><span class="va">col_five_hues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"#3d291a"</span>,</span>
<span>  <span class="st">"#a9344f"</span>,</span>
<span>  <span class="st">"#578a5b"</span>,</span>
<span>  <span class="st">"#83a6c4"</span>,</span>
<span>  <span class="st">"#fcc573"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Evoregions can now be mapped using the following code</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">map_evoregion</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">evoregion_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">site_region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">""</span>, </span>
<span>    labels <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">col_five_hues</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sf_evoregion</span>, </span>
<span>    color <span class="op">=</span> <span class="st">"#040400"</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Longitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Latitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/outFig2-1.png" alt="Figure 2 - Evoregions for Akodon species communities" width="70%"><p class="caption">
Figure 2 - Evoregions for Akodon species communities
</p>
</div>
<p><code>evoregion</code> produced five distinct regions, but not all
cells have the same degree of affiliation with the region in which it
was classified. Cells with high affiliation indicates assemblages that
are more similar to all the other cells presented in the region, on the
other hand assemblages with low values of affiliation correspond to <a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13492" class="external-link">turnover
areas</a>, in other words, areas with multiple events of colonization by
different lineages.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Selecting only axis with more than 5% of explained variance from evoregion output</span></span>
<span><span class="va">axis_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">regions</span><span class="op">$</span><span class="va">PCPS</span><span class="op">$</span><span class="va">prop_explainded</span> <span class="op">&gt;=</span> <span class="va">regions</span><span class="op">$</span><span class="va">PCPS</span><span class="op">$</span><span class="va">tresh_dist</span><span class="op">)</span></span>
<span><span class="va">PCPS_thresh</span> <span class="op">&lt;-</span> <span class="va">regions</span><span class="op">$</span><span class="va">PCPS</span><span class="op">$</span><span class="va">vectors</span><span class="op">[</span>, <span class="va">axis_sel</span><span class="op">]</span> </span>
<span></span>
<span><span class="co"># distance matrix using 4 significant PCPS axis accordingly to the 5% threshold </span></span>
<span><span class="va">dist_phylo_PCPS</span> <span class="op">&lt;-</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/vegan/man/vegdist.html" class="external-link">vegdist</a></span><span class="op">(</span><span class="va">PCPS_thresh</span>, method <span class="op">=</span> <span class="st">"euclidean"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating affiliation values for each assemblage </span></span>
<span><span class="va">afi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_affiliation_evoreg.html">calc_affiliation_evoreg</a></span><span class="op">(</span>phylo.comp.dist <span class="op">=</span> <span class="va">dist_phylo_PCPS</span>,</span>
<span>                          groups <span class="op">=</span> <span class="va">site_region</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># binding the information in a data frame</span></span>
<span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site_xy</span>, site_region <span class="op">=</span>  <span class="va">site_region</span>, <span class="va">afi</span><span class="op">)</span></span></code></pre></div>
<p>Now we can map both evoregions and the affiliation of each cell. The
degree of affiliation of cells are showed as the degree of fading for
each color representing the evoregions. As faded the color of the cell,
lesser the affiliation of that cell to its evoregion. Those cell can be
interpreted as being zones of high phylogenetic turnover.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_joint_evoregion_afilliation</span> <span class="op">&lt;-</span> </span>
<span>   <span class="va">evoregion_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">site_region</span><span class="op">)</span>, </span>
<span>               alpha <span class="op">=</span> <span class="va">sites</span><span class="op">[</span>, <span class="st">"afilliation"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span></span>
<span>     name <span class="op">=</span> <span class="st">""</span>, </span>
<span>     labels <span class="op">=</span> <span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">col_five_hues</span><span class="op">)</span></span>
<span>   <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>     data <span class="op">=</span> <span class="va">sf_evoregion</span>, </span>
<span>     color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">col_five_hues</span><span class="op">)</span>,</span>
<span>     fill <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>     size <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>direction <span class="op">=</span> <span class="st">"vertical"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Longitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Latitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/outFig3-1.png" alt="Figure 3 - Evoregion and afilliation for communities of Akodon Genus" width="70%"><p class="caption">
Figure 3 - Evoregion and afilliation for communities of Akodon Genus
</p>
</div>
</div>
<div class="section level2">
<h2 id="mergeMacroAssemblage">Ancestral area reconstruction for Akodon species<a class="anchor" aria-label="anchor" href="#mergeMacroAssemblage"></a>
</h2>
<p>In this section we will show how Herodotools can use the results that
comes from macroevolutionary analysis, particularly analysis of
ancestral state reconstruction, to understand the role of
diversification and historical dispersal at assemblage level. For this
we will use an ancestral area reconstruction performed with <a href="https://github.com/nmatzke/BioGeoBEARS" class="external-link">BioGeoBEARS</a>, a tool
commonly used in macroevolution.</p>
<p>First, we have to define the occurrence of each species in the
evoregions. To do this we can use the function
<code>get_region_occ</code> and obtain a data frame of species in the
lines and evoregions in the columns.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">a_region</span> <span class="op">&lt;-</span> <span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/get_region_occ.html">get_region_occ</a></span><span class="op">(</span>comm <span class="op">=</span> <span class="va">akodon_pa_tree</span>, site.region <span class="op">=</span> <span class="va">site_region</span><span class="op">)</span></span></code></pre></div>
<p>The object created in the last step can be used in an auxiliary
function in Herodotools to easily produce the <a href="http://scikit-bio.org/docs/0.2.3/generated/skbio.io.phylip.html" class="external-link">Phyllip</a>
file required to run the analysis of ancestral area reconstruction using
BioGeoBEARS.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save phyllip file</span></span>
<span><span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/get_tipranges_to_BioGeoBEARS.html">get_tipranges_to_BioGeoBEARS</a></span><span class="op">(</span></span>
<span>  <span class="va">a_region</span>, </span>
<span>  <span class="co"># please set a new path to save the file</span></span>
<span>  filename <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"inst"</span>, <span class="st">"extdata"</span>, <span class="st">"geo_area_akodon.data"</span><span class="op">)</span>,</span>
<span>  areanames <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning in Herodotools::get_tipranges_to_BioGeoBEARS(a_region, filename = here::here("inst", : </span></span>
<span><span class="co">#&gt; Note: assigning 'A B C D E' as area names.</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/Herodotools/Herodotools/inst/extdata/geo_area_akodon.data"</span></span></code></pre></div>
<p>Since it take some time to run BioGeoBEARS (about 15 minutes in a 4GB
processor machine), and we are not focused on macroevolutionary analysis
using BioGeoBEARS, we can just read a reconstruction model performed
using DEC model to reconstruct the evoregions. However, if you want to
see the code we used to run the BioGeoBEARS models, you can access it
with
<code>file.edit(system.file("extdata", "script", "e_01_run_DEC_model.R", package = "Herodotools"))</code>.</p>
<p>Read the file containing the results of DEC model reconstruction:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># ancestral reconstruction</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"resDEC_akodon.RData"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>It is worth to note that the procedures described here can be adapted
to work with any model of ancestral area reconstruction from
BioGeoBEARS, but for sake of simplicity we decided to use only the <a href="https://revbayes.github.io/tutorials/biogeo/biogeo_intro.html" class="external-link">DEC
model</a>.</p>
</div>
<div class="section level2">
<h2 id="modelBasedMetrics">Merging macroevolutionary models with assemblage level metrics<a class="anchor" aria-label="anchor" href="#modelBasedMetrics"></a>
</h2>
<p>Once we have data on present-day occurrence of species, a
biogeographical regionalization (obtained with <code>evoregions</code>
function) and the ancestral area reconstruction, we can integrate these
information to calculate metrics implemented in Herodotools that
represent historical variables at assemblage scale.</p>
<div class="section level3">
<h3 id="age-of-assemblages">Age of assemblages<a class="anchor" aria-label="anchor" href="#age-of-assemblages"></a>
</h3>
<p>Let’s start by calculating the age of each cell considering the
macroevolutionary dynamics of in situ diversification during time . The
age here corresponds to the mean arrival time of each species occupying
a given assemblage. By arrival time we mean the most ancient ancestor
from a lineage that arrived at the assemblage within a region in which
the current species occur today. For the original description of this
metric see <a href="https://academic.oup.com/biolinnean/article-abstract/134/1/57/6297962" class="external-link">Van
Dijk et al. 2021</a></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># converting numbers to character</span></span>
<span><span class="va">biogeo_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>biogeo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">chartr</a></span><span class="op">(</span><span class="st">"12345"</span>, <span class="st">"ABCDE"</span>, <span class="va">evoregion_df</span><span class="op">$</span><span class="va">site_region</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># getting the ancestral range area for each node </span></span>
<span><span class="va">node_area</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/get_node_range_BioGeoBEARS.html">get_node_range_BioGeoBEARS</a></span><span class="op">(</span></span>
<span>    <span class="va">resDEC</span>,</span>
<span>    phyllip.file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"inst"</span>, <span class="st">"extdata"</span>, <span class="st">"geo_area_akodon.data"</span><span class="op">)</span>,</span>
<span>    <span class="va">akodon_newick</span>,</span>
<span>    max.range.size <span class="op">=</span> <span class="fl">4</span> </span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># calculating age arrival </span></span>
<span><span class="va">age_comm</span> <span class="op">&lt;-</span> <span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_age_arrival.html">calc_age_arrival</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon_pa_tree</span>, </span>
<span>                        tree <span class="op">=</span> <span class="va">akodon_newick</span>, </span>
<span>                        ancestral.area <span class="op">=</span> <span class="va">node_area</span>, </span>
<span>                        biogeo <span class="op">=</span> <span class="va">biogeo_area</span><span class="op">)</span> </span></code></pre></div>
<p>The function <code>calc_age_arrival</code> returns a object
containing the mean age for each assemblage. Species in which the
transition to the current region occurred between the last ancestor and
the present can be dealt in two ways: the default is by represent it as
a very recent arrival age for those species, and another option is to
attribute the age corresponding to half of the branch length connecting
the ancestor to the present time. Here we adopted the first option.</p>
<p>With mean age for each assemblage we can map the ages for all
assemblages</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site_xy</span>, site_region <span class="op">=</span>  <span class="va">site_region</span>, age <span class="op">=</span> <span class="va">age_comm</span><span class="op">$</span><span class="va">mean_age_per_assemblage</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map_age</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">mean_age_arrival</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"quantitative"</span>, </span>
<span>                     palette <span class="op">=</span> <span class="st">"SunsetDark"</span>,</span>
<span>                     direction <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3.5</span><span class="op">)</span>,  <span class="co">## max percent overall</span></span>
<span>                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3.5</span>, by <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{seq(0, 3.5, by = 0.5)}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Mean age (Myr)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2.3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                               direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                               ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                               title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                               label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                               title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.margin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, </span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/outFig4-1.png" alt="Figure 4 - Age of assemblages" width="70%"><p class="caption">
Figure 4 - Age of assemblages
</p>
</div>
</div>
<div class="section level3">
<h3 id="phylomodelmetrics">Model-based diversification metrics<a class="anchor" aria-label="anchor" href="#phylomodelmetrics"></a>
</h3>
<p>We can also calculate measures of diversification considering the
macroevolutionary dynamics of ancestors, specifically, we can measure
the importance of in situ diversification for assemblage level metrics.
The new measures allows to decompose the effects of two
macroevolutionary process: in situ diversification and ex situ. Here we
will illustrate this by calculating a common tip-based diversification
measure proposed by <a href="">Redding and Moers</a> that consists in
the inverse of equal-splits measure called Diversification Rate
(DR).</p>
<p>We modified the original metric to take into account only the portion
of evolutionary history that is associated with the region in which the
species currently occupy, this value represent the diversification that
occurred due to <em>in situ diversification process</em></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">akodon_diversification</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_insitu_diversification.html">calc_insitu_diversification</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon_pa_tree</span>,</span>
<span>                   tree <span class="op">=</span> <span class="va">akodon_newick</span>, </span>
<span>                   ancestral.area <span class="op">=</span> <span class="va">node_area</span>, </span>
<span>                   biogeo <span class="op">=</span> <span class="va">biogeo_area</span>, </span>
<span>                   diversification <span class="op">=</span> <span class="st">"jetz"</span>,</span>
<span>                   type <span class="op">=</span> <span class="st">"equal.splits"</span><span class="op">)</span></span></code></pre></div>
<p>The result of <code>calc_insitu_diversification</code> function
consist of a data-frame containing the value of in-situ diversification
for each species in each assemblage and a vector with the harmonic mean
in-situ diversification for each assemblage. As with age, we can plot
the in-situ diversification metric to look at the spatial patterns in
Akodon assemblages.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site_xy</span>,</span>
<span>                   site_region <span class="op">=</span>  <span class="va">site_region</span>,</span>
<span>                   age <span class="op">=</span> <span class="va">age_comm</span><span class="op">$</span><span class="va">mean_age_per_assemblage</span>,</span>
<span>                   diversification_model_based <span class="op">=</span> <span class="va">akodon_diversification</span><span class="op">$</span><span class="va">model_based_Jetz_harmonic_mean_site</span>,</span>
<span>                   diversification <span class="op">=</span> <span class="va">akodon_diversification</span><span class="op">$</span><span class="va">Jetz_harmonic_mean_site</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map_diversification</span> <span class="op">&lt;-</span> </span>
<span>   <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">diversification</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"quantitative"</span>, palette <span class="op">=</span> <span class="st">"SunsetDark"</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"DR"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                               direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                               ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                               title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                               label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                               title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>     legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>     axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>     axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span><span class="va">map_diversification_insitu</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">diversification_model_based</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"quantitative"</span>,</span>
<span>                     palette <span class="op">=</span> <span class="st">"SunsetDark"</span>, </span>
<span>                     direction <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,  <span class="co">## max percent overall</span></span>
<span>                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{seq(0, 1, by = 0.25)}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"B"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"DRinsitu"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                               direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                               ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                               title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                               label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                               title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>, </span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span> <span class="co"># using patchwork to put the maps together</span></span>
<span><span class="va">map_diversification_complete</span> <span class="op">&lt;-</span> <span class="va">map_diversification</span> <span class="op">+</span> <span class="va">map_diversification_insitu</span></span></code></pre></div>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/outFig5-1.png" alt="Figure 5 - Diversification rates (DR - A) and in situ diversification rate (DRinsitu - B) for Akodon assemblages" width="70%"><p class="caption">
Figure 5 - Diversification rates (DR - A) and in situ diversification
rate (DRinsitu - B) for Akodon assemblages
</p>
</div>
</div>
<div class="section level3">
<h3 id="historical-dispersal-events">Historical dispersal events<a class="anchor" aria-label="anchor" href="#historical-dispersal-events"></a>
</h3>
<p>We can also calculate the importance of dispersal events related to
each ancestral range. By using the function
<code>calc_dispersal_from</code> we can quantify the contribution of a
given region to historical dispersal of the species in present-day
assemblages. This is done by calculating the proportion of species in an
assemblage that dispersed from the focal ancestral range to other
regions. This calculation accounts only for the species that present
events of dispersal in its ancestral lineage, in other words, species
that presented their whole history shaped by in situ diversification are
not considered in this analysis.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">akodon_dispersal</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_dispersal_from.html">calc_dispersal_from</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon_pa_tree</span>,</span>
<span>               tree <span class="op">=</span> <span class="va">akodon_newick</span>, </span>
<span>               ancestral.area <span class="op">=</span> <span class="va">node_area</span>, </span>
<span>               biogeo <span class="op">=</span> <span class="va">biogeo_area</span><span class="op">)</span></span></code></pre></div>
<p>We also can map the contribution of dispersal for all regions. Note
that the focal area of ancestral range in each map have no values of
dipersal from, since it is the source of dispersal to the other
regions.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site_xy</span>,</span>
<span>                   site_region <span class="op">=</span>  <span class="va">site_region</span>, </span>
<span>                   age <span class="op">=</span> <span class="va">age_comm</span><span class="op">$</span><span class="va">mean_age_per_assemblage</span>,</span>
<span>                   diversification <span class="op">=</span> <span class="va">akodon_diversification</span><span class="op">$</span><span class="va">Jetz_harmonic_mean_site</span>,</span>
<span>                   diversification_model_based <span class="op">=</span> <span class="va">akodon_diversification</span><span class="op">$</span><span class="va">model_based_Jetz_harmonic_mean_site</span>,</span>
<span>                   dispersal.D <span class="op">=</span> <span class="va">akodon_dispersal</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, </span>
<span>                   dispersal.A <span class="op">=</span> <span class="va">akodon_dispersal</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>                   dispersal.E <span class="op">=</span> <span class="va">akodon_dispersal</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>,</span>
<span>                   dispersal.BD <span class="op">=</span> <span class="va">akodon_dispersal</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span>,</span>
<span>                   dispersal.B <span class="op">=</span> <span class="va">akodon_dispersal</span><span class="op">[</span>, <span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map_dispersal_D</span> <span class="op">&lt;-</span> </span>
<span>   <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">dispersal.D</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"quantitative"</span>, palette <span class="op">=</span> <span class="st">"SunsetDark"</span>, na.value <span class="op">=</span> <span class="st">"white"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>     <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"From D"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"% of contribution"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2.3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                               direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                               ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                               title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                               label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                               title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>, </span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">map_dispersal_A</span> <span class="op">&lt;-</span> </span>
<span>   <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">dispersal.A</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span></span>
<span>     type <span class="op">=</span> <span class="st">"quantitative"</span>, palette <span class="op">=</span> <span class="st">"SunsetDark"</span>, na.value <span class="op">=</span> <span class="st">"white"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>     <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"From A"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"% of contribution"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2.3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                               direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                               ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                               title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                               label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                               title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>, </span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">map_dispersal_B</span> <span class="op">&lt;-</span> </span>
<span>   <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">dispersal.B</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span></span>
<span>     type <span class="op">=</span> <span class="st">"quantitative"</span>, palette <span class="op">=</span> <span class="st">"SunsetDark"</span>, na.value <span class="op">=</span> <span class="st">"white"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>     <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"From B"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"% of\ncontribution"</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>     legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>     axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>     legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>, </span>
<span>     axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>     plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>   </span>
<span>   <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/outFig6-1.png" alt="Figure 6 - Maps showing regionalization based on phylogenetic turnover (evoregion - top figure), and the contribution of regions A, B and D to other regions regarding historical dispersal of lineages" width="70%"><p class="caption">
Figure 6 - Maps showing regionalization based on phylogenetic turnover
(evoregion - top figure), and the contribution of regions A, B and D to
other regions regarding historical dispersal of lineages
</p>
</div>
</div>
<div class="section level3">
<h3 id="phylomodelmetricscomm">Model based community phylogetic metrics<a class="anchor" aria-label="anchor" href="#phylomodelmetricscomm"></a>
</h3>
<p>We also can calculate common metrics of community phylogenetics
considering the macroevolutionary dynamics in the calculation. These
model-based community phylogenetic metrics allows to disentangle the
effects of in-situ diversification from ex-situ. For this we use the
function <code>calc_insitu_metrics</code></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">akodon_PD_PE_insitu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_insitu_metrics.html">calc_insitu_metrics</a></span><span class="op">(</span>W <span class="op">=</span> <span class="va">akodon_pa_tree</span>,</span>
<span>                  tree <span class="op">=</span> <span class="va">akodon_newick</span>, </span>
<span>                  ancestral.area <span class="op">=</span> <span class="va">node_area</span>, </span>
<span>                  biogeo <span class="op">=</span> <span class="va">biogeo_area</span>, </span>
<span>                  PD <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                  PE <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>As the other metrics we can plot PDinsitu and PEinsitu in a map</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site_xy</span>,</span>
<span>                   site_region <span class="op">=</span>  <span class="va">site_region</span>, </span>
<span>                   age <span class="op">=</span> <span class="va">age_comm</span><span class="op">$</span><span class="va">mean_age_per_assemblage</span>,</span>
<span>                   diversification <span class="op">=</span> <span class="va">akodon_diversification</span><span class="op">$</span><span class="va">Jetz_harmonic_mean_site</span>,</span>
<span>                   PE <span class="op">=</span> <span class="va">akodon_PD_PE_insitu</span><span class="op">$</span><span class="va">PE</span>, </span>
<span>                   PEinsitu <span class="op">=</span> <span class="va">akodon_PD_PE_insitu</span><span class="op">$</span><span class="va">PEinsitu</span>,</span>
<span>                   PD <span class="op">=</span> <span class="va">akodon_PD_PE_insitu</span><span class="op">$</span><span class="va">PD</span>,</span>
<span>                   PDinsitu <span class="op">=</span> <span class="va">akodon_PD_PE_insitu</span><span class="op">$</span><span class="va">PDinsitu</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map_PE</span> <span class="op">&lt;-</span> </span>
<span>   <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">PE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"SunsetDark"</span>, </span>
<span>                                  direction <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.6</span><span class="op">)</span>,  <span class="co">## max percent overall</span></span>
<span>                                  breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.6</span>, by <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span>
<span>                                  <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"PE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2.3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                               direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                               ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                               title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                               label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                               title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>     legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>     axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span><span class="va">map_PEinsitu</span> <span class="op">&lt;-</span> </span>
<span>   <span class="va">sites</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">PEinsitu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"SunsetDark"</span>, </span>
<span>                                  direction <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.6</span><span class="op">)</span>,  <span class="co">## max percent overall</span></span>
<span>                                  breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.6</span>, by <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span></span>
<span>                                  <span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"B"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"PEinsitu"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2.3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                               direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                               ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                               title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                               label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                               title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>     legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>     axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span><span class="va">map_PE_all</span> <span class="op">&lt;-</span> <span class="va">map_PE</span> <span class="op">+</span> <span class="va">map_PEinsitu</span></span></code></pre></div>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/fig7_PEdb-1.png" alt="Figure 7 - Phylogenetic endemism (A), and in situ phylogenetic endemism (B) for Akodon assemblages" width="70%"><p class="caption">
Figure 7 - Phylogenetic endemism (A), and in situ phylogenetic endemism
(B) for Akodon assemblages
</p>
</div>
<p>Figure 7 shows that the endemism pattern for Akodon assemblages are
similar for both metrics, indicating that regions with high endemism are
mainly due to in-situ diversificaiton process.</p>
</div>
<div class="section level3">
<h3 id="traitdynamics">Tip-based metrics of trait evolution<a class="anchor" aria-label="anchor" href="#traitdynamics"></a>
</h3>
<p>Here we will show how to implement three tip-based metrics proposed
by <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.8476" class="external-link">Luza
et al. (2021)</a>. Note that these tip-based metrics were estimated
using the stochastic mapping of discrete/categorical traits (diet in the
original publication), but can be extended to other traits as we will
show here. The three tip-based metrics are <em>Transition rates</em>,
<em>Stasis time</em>, and <em>Last transition time</em>, and are
implemented in the function <code>calc_tip_based_trait_evo</code>.
<em>Transition rates</em> indicate how many times the ancestral
character has changed over time. <em>Stasis time</em> indicates the
maximum branch length (time interval) which the current tip-character
was maintained across the whole phylogeny. Finally, <em>last transition
time</em> is the sum of branch lengths from the tip to the
prior/previous node with a reconstructed character equal to current
tip-character. As in the <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/ece3.8476" class="external-link">original
publication</a>, we will use the stochastic character mapping on
discrete trait data. This time, however, we will reconstruct the species
foraging strata (Elton Traits’ database, Wilman et al. 2014). We will
reconstruct the foraging strata for 214 sigmodontine rodent species with
trait and phylogenetic data (consensus phylogeny of <a href="https://journals.plos.org/plosbiology/article?id=10.1371/journal.pbio.3000494" class="external-link">Upham
et al. 2019</a>).</p>
<p>First we will load trait and phylogenetic data we need to run the
function <code>calc_tip_based_trait_evo</code>.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"rodent_phylo"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"trait"</span><span class="op">)</span></span></code></pre></div>
<p>Now calculate the metrics.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run `calc_tip_based_trait_evo` function </span></span>
<span><span class="va">trans_rates</span> <span class="op">&lt;-</span> <span class="fu">Herodotools</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_tip_based_trait_evo.html">calc_tip_based_trait_evo</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">match_data</span><span class="op">$</span><span class="va">phy</span>,</span>
<span>                                   trait <span class="op">=</span> <span class="va">trait</span> , <span class="co"># need to be named to work</span></span>
<span>                                   nsim <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                   method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"transition_rates"</span>,</span>
<span>                                              <span class="st">"last_transition_time"</span>,</span>
<span>                                              <span class="st">"stasis_time"</span><span class="op">)</span></span>
<span>                                   <span class="op">)</span></span>
<span>  </span></code></pre></div>
<p>Since this analysis can take several minutes we can read the result
obtained using the same code above</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"transition_rate_res.RData"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we have in hand the estimates of the three tip-based metrics for
214 rodent species. We can summarize the tip-based metrics at the
ecological assemblage scale. First we will load assemblage &amp;
geographic data comprising 1770 grid cells located at the
Neotropics.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># load community data</span></span>
<span><span class="va">comm_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"PresAbs_228sp_Neotropical_MainDataBase_Ordenado.txt"</span>, </span>
<span>               package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span>,</span>
<span>   header <span class="op">=</span> <span class="cn">T</span>, sep <span class="op">=</span> <span class="st">"\t"</span></span>
<span>   <span class="op">)</span></span>
<span></span>
<span><span class="co"># load latlong of these communities</span></span>
<span><span class="va">geo_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Lon-lat-Disparity.txt"</span>, package <span class="op">=</span> <span class="st">"Herodotools"</span><span class="op">)</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">T</span>, sep <span class="op">=</span> <span class="st">"\t"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Now we calculate the values of tip-based metrics for all species for
each assemblage.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># transition rates for each community</span></span>
<span><span class="va">averaged_rates</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comm_data</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># across assemblages</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">trans_rates</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op">{</span> <span class="co"># across simulations</span></span>
<span>    </span>
<span>    <span class="co"># species in the assemblages</span></span>
<span>    <span class="va">gather_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">comm_data</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">comm_data</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co"># get the names</span></span>
<span>    <span class="co"># subset of rates</span></span>
<span>    <span class="va">rates</span> <span class="op">&lt;-</span> <span class="va">sims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span> <span class="op">(</span><span class="va">sims</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">gather_names</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prop.transitions"</span>, </span>
<span>                     <span class="st">"stasis.time"</span>,</span>
<span>                     <span class="st">"last.transition.time"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">mean_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">rates</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span> <span class="co"># and calculate the average</span></span>
<span>    <span class="va">mean_rates</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Since the last step take some minutes to complete you can opt to read
directly fom the package the table with mean values for all metrics</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"averaged_rates"</span><span class="op">)</span></span></code></pre></div>
<p>We will represent in space the variation in the tip-based metrics for
rodent assemblages. It seems that, in general, assemblages of the
southern, western and northeastern Neotropics have species with higher
Transition Rates in foraging strata than communities from elsewhere
(i.e., they have many species that often changed their foraging strata
over time). Assemblage-level Stasis Time was high for two groups of
assemblages: one from northeastern Neotropics, and another in central
Amazonia. The first group in particular also showed high Transition
Rates. Taken together, these results indicate that, despite the frequent
changes in foraging strata, the species of northeastern assemblages
retained their phenotipic state during more time than the species found
elsewhere. Finally, the Last Transition Time metric shows that the
transitions leading to the present species foraging strata were older in
the i) north of the Amazonia and ii) central Mexico. These results are
potentially reflecting i) the location of arrival of ancestral
sigmodontine rodents in south America, and ii) the occurrence of several
species closely related to basal lineages.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># prepare data to map</span></span>
<span><span class="va">data_to_map_wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">geo_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LONG"</span>, <span class="st">"LAT"</span><span class="op">)</span><span class="op">]</span>, <span class="va">averaged_rates</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_to_map_long</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">data_to_map_wide</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"variables"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"values"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># create a list with the maps</span></span>
<span><span class="va">list_map_transitions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data_to_map_long</span><span class="op">$</span><span class="va">variables</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">metric</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">plot.title</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">metric</span>,</span>
<span>    <span class="st">"prop.transitions"</span> <span class="op">=</span> <span class="st">"Transition Rates"</span>,</span>
<span>    <span class="st">"stasis.time"</span> <span class="op">=</span> <span class="st">"Stasis Time"</span>,</span>
<span>    <span class="st">"last.transition.time"</span> <span class="op">=</span> <span class="st">"Last Transition Time"</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">sel_data</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">data_to_map_long</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variables</span> <span class="op">==</span> <span class="va">metric</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">var_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">sel_data</span><span class="op">$</span><span class="va">values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">var_breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">var_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">var_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">var_range</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">sig_map_limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">sel_data</span><span class="op">$</span><span class="va">LONG</span><span class="op">)</span>, </span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">sel_data</span><span class="op">$</span><span class="va">LAT</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sel_data</span>, </span>
<span>                <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">LONG</span>, y <span class="op">=</span> <span class="va">LAT</span>, fill <span class="op">=</span> <span class="va">values</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">rcartocolor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_scale.html" class="external-link">scale_fill_carto_c</a></span><span class="op">(</span></span>
<span>      type <span class="op">=</span> <span class="st">"quantitative"</span>, </span>
<span>      palette <span class="op">=</span> <span class="st">"SunsetDark"</span>, </span>
<span>      na.value <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>      limits <span class="op">=</span> <span class="va">var_range</span>, </span>
<span>      breaks <span class="op">=</span> <span class="va">var_breaks</span></span>
<span>    <span class="op">)</span><span class="op">+</span> </span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coastline</span>, size <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">sig_map_limits</span><span class="op">$</span><span class="va">x</span>, ylim <span class="op">=</span> <span class="va">sig_map_limits</span><span class="op">$</span><span class="va">y</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>barheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2.3</span>, units <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,  </span>
<span>                                 direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>                                 ticks.colour <span class="op">=</span> <span class="st">"grey20"</span>,</span>
<span>                                 title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>                                 label.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>                                 title.hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">plot.title</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>      axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, </span>
<span>      axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>      plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>   </span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create map</span></span>
<span><span class="va">mapTransition_rate</span> <span class="op">&lt;-</span> <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">list_map_transitions</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Warning: Raster pixels are placed at uneven horizontal intervals and will be shifted</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Consider using `geom_tile()` instead.</span></span>
<span><span class="co">#&gt; Raster pixels are placed at uneven horizontal intervals and will be shifted</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Consider using `geom_tile()` instead.</span></span>
<span><span class="co">#&gt; Raster pixels are placed at uneven horizontal intervals and will be shifted</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Consider using `geom_tile()` instead.</span></span>
<span><span class="co">#&gt; Raster pixels are placed at uneven horizontal intervals and will be shifted</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Consider using `geom_tile()` instead.</span></span>
<span><span class="co">#&gt; Raster pixels are placed at uneven horizontal intervals and will be shifted</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Consider using `geom_tile()` instead.</span></span>
<span><span class="co">#&gt; Raster pixels are placed at uneven horizontal intervals and will be shifted</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Consider using `geom_tile()` instead.</span></span></code></pre>
<div class="figure">
<img src="Intro_Herodotools_vignette_files/figure-html/fig8-1.png" alt="Figure 8: Maps with tip metrics of evolution dynamics of life mode for Sigmodontine species" width="700"><p class="caption">
Figure 8: Maps with tip metrics of evolution dynamics of life mode for
Sigmodontine species
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Duarte, L. D. S., Debastiani, V. J., Freitas, A. V. L., &amp;
Pillar, V. D. P. (2016). Dissecting phylogenetic fuzzy weighting: theory
and application in metacommunity phylogenetics. Methods in Ecology and
Evolution, February, 937-946. doi.org/10.1111/2041-210X.12547</p></li>
<li><p>Jombart, T., Devillar S., &amp; Ballox, F. (2010). Discriminant
analysis of principal components: a new method for the analysis of
genetically structured populations. BMC Genomic Data.</p></li>
<li><p>Luza, A. L., Maestri, R., Debastiani, V. J., Patterson, B. D.,
Maria, S., &amp; Leandro, H. (2021). Is evolution faster at ecotones? A
test using rates and tempo of diet transitions in Neotropical
Sigmodontinae ( Rodentia , Cricetidae ). Ecology and Evolution,
December, 18676–18690. <a href="https://doi.org/10.1002/ece3.8476" class="external-link uri">https://doi.org/10.1002/ece3.8476</a></p></li>
<li><p>Maestri, R., &amp; Duarte, L. D. S. (2020). Evoregions: Mapping
shifts in phylogenetic turnover across biogeographic regions Renan
Maestri. Methods in Ecology and Evolution, 2020(August), 1652–1662. <a href="https://doi.org/10.1111/2041-210X.13492" class="external-link uri">https://doi.org/10.1111/2041-210X.13492</a></p></li>
<li><p>Pigot, A. and Etienne, R. (2015). A new dynamic null model for
phylogenetic community structure. Ecology Letters, 18(2), 153-163. <a href="https://doi.org/10.1111/ele.12395" class="external-link uri">https://doi.org/10.1111/ele.12395</a></p></li>
<li><p>Van Dijk, A., Nakamura, G., Rodrigues, A. V., Maestri, R., &amp;
Duarte, L. (2021b). Imprints of tropical niche conservatism and
historical dispersal in the radiation of Tyrannidae (Aves:
Passeriformes). Biological Journal of the Linnean Society, 134(1),
57–67. <a href="https://doi.org/10.1093/biolinnean/blab079" class="external-link uri">https://doi.org/10.1093/biolinnean/blab079</a></p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Gabriel Nakamura, Arthur Rodrigues, André Luza, Vanderlei Debastiani, Renan Maestri, Leandro Duarte.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
